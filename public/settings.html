<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - Cadillac EV Assistant</title>
    <link rel="stylesheet" href="styles.css?v=1730000010">
    <link rel="stylesheet" href="settings-redesign.css?v=1730000010">
    <script src="kb-functions.js?v=1730000014"></script>
    <script src="td-functions.js?v=1730000010"></script>
    <script src="branding-functions.js?v=1730000010"></script>
    <script src="js/i18n.js?v=1730000020"></script>
    <style>
        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 70px;
        }
        
        .settings-header {
            margin-bottom: 30px;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }
        
        .settings-tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .settings-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .settings-tab:hover {
            color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .branding-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d2d2d;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #9ca3af;
            margin-bottom: 15px;
        }
        
        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex !important;
            width: auto !important;
            white-space: nowrap;
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 500;
            color: #2d2d2d;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .stat-description {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .kb-search {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: nowrap;
        }
        
        .kb-search-input {
            flex: 1;
            min-width: 200px;
            height: 44px;
            padding: 0 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            box-sizing: border-box;
            line-height: normal;
        }
        
        .kb-filter, .kb-sort {
            height: 44px;
            padding: 0 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .kb-actions {
            display: flex;
            gap: 10px;
        }
        
        .kb-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .kb-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .kb-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .kb-item-title {
            font-weight: 500;
            color: #2d2d2d;
            font-size: 16px;
        }
        
        .kb-item-date {
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
        }
        
        .kb-tools {
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
            flex-shrink: 0;
        }
        
        .kb-tool-btn {
            padding: 8px 12px !important;
            border: 1px solid #d1d5db !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            min-width: 32px !important;
            height: 32px !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: #f3f4f6 !important;
        }
        
        .kb-tool-btn.primary {
            background: #3b82f6 !important;
            border-color: #2563eb !important;
            color: white !important;
        }
        
        .kb-tool-btn.primary:hover {
            background: #2563eb !important;
            border-color: #1d4ed8 !important;
        }
        
        
        .kb-tool-btn.danger {
            background: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        
        .kb-tool-btn.danger:hover {
            background: #dc2626 !important;
            border-color: #b91c1c !important;
        }
        
        .kb-item-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-type-badge, .file-size-badge, .kb-item-category {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .file-type-badge {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .file-size-badge {
            background: #f3f4f6;
            color: #374151;
        }
        
        .kb-item-category {
            background: #fef3c7;
            color: #92400e;
        }
        
        .kb-checkbox {
            margin-right: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: #1f2937;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #ef4444;
        }
        
        /* Dark Mode Styles */
        [data-theme="dark"] body,
        body[data-theme="dark"] {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        [data-theme="dark"] .settings-container {
            background: #1a1a1a;
        }
        
        [data-theme="dark"] .branding-section,
        [data-theme="dark"] .form-group,
        [data-theme="dark"] .color-picker-group {
            background: #2d2d2d;
            border-color: #404040;
        }
        
        [data-theme="dark"] .settings-tab {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: #404040;
        }
        
        [data-theme="dark"] .settings-tab.active {
            background: #3d3d3d;
            border-bottom-color: #3d3d3d;
        }
        
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="color"],
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: #3d3d3d;
            color: #e0e0e0;
            border-color: #505050;
        }
        
        [data-theme="dark"] input[type="text"]::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #888;
        }
        
        [data-theme="dark"] label {
            color: #e0e0e0;
        }
        
        [data-theme="dark"] .btn {
            background: #3d3d3d;
            color: #e0e0e0;
            border-color: #505050;
        }
        
        [data-theme="dark"] .btn:hover {
            background: #4d4d4d;
        }
        
        [data-theme="dark"] .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        [data-theme="dark"] .btn-primary:hover {
            background: #2563eb;
        }
        
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #f0f0f0;
        }
        
        [data-theme="dark"] p,
        [data-theme="dark"] span {
            color: #e0e0e0;
        }
        
        /* Override inline styles for specific sections */
        [data-theme="dark"] div[style*="background: #f9fafb"],
        [data-theme="dark"] div[style*="background:#f9fafb"],
        [data-theme="dark"] div[style*="background: white"],
        [data-theme="dark"] div[style*="background:#fff"],
        [data-theme="dark"] div[style*="background: #fff"] {
            background: #2d2d2d !important;
        }
        
        [data-theme="dark"] span[style*="color: #374151"],
        [data-theme="dark"] span[style*="color:#374151"] {
            color: #e0e0e0 !important;
        }
        
        [data-theme="dark"] .nav {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }
        
        [data-theme="dark"] .nav-item {
            color: #e0e0e0;
        }
        
        [data-theme="dark"] .nav-item:hover,
        [data-theme="dark"] .nav-item.active {
            background: #3d3d3d;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-brand-icon" id="navLogo">C</div>
            <span id="navBrandText">Cadillac EV</span>
        </div>
        <div class="nav-menu">
            <a class="nav-item" href="dashboard.html" data-page="dashboard" data-i18n="nav.dashboard">Dashboard</a>
            <a class="nav-item" href="chat.html" data-page="chat" data-i18n="nav.chat">Chat</a>
            <a class="nav-item" href="troubleshooting.html" data-page="troubleshooting" data-i18n="nav.troubleshooting">Troubleshooting</a>
            <a class="nav-item active" href="settings.html" data-page="settings" data-i18n="nav.settings">Einstellungen</a>
            <select class="language-selector" id="languageSelector" onchange="if(window.i18n) window.i18n.changeLanguage(this.value)" title="Sprache wählen">
                <option value="de">DE</option>
                <option value="en">EN</option>
                <option value="fr">FR</option>
            </select>
            <button class="theme-toggle" id="themeToggle" title="Theme wechseln" onclick="window.toggleTheme()">
                <svg class="theme-icon sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <svg class="theme-icon moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <div class="settings-container">
            <div class="settings-header">
            <h1 style="font-weight: 500; color: #2d2d2d;" data-i18n="settings.title">Einstellungen</h1>
            <p style="color: #6b7280; font-weight: 500;" data-i18n="settings.subtitle">Verwalten Sie Ihre Anwendungseinstellungen</p>
            </div>
            
            <div class="settings-tabs">
            <button class="settings-tab active" data-tab="branding" onclick="switchSettingsTab('branding')" data-i18n="settings.tabs.branding">Branding</button>
            <button class="settings-tab" data-tab="knowledge" onclick="switchSettingsTab('knowledge')" data-i18n="settings.tabs.knowledgeDb">Wissensdatenbank</button>
            <button class="settings-tab" data-tab="technical" onclick="switchSettingsTab('technical')" data-i18n="settings.tabs.technicalDb">Technische Datenbank</button>
            <button class="settings-tab" data-tab="general" onclick="switchSettingsTab('general')" data-i18n="settings.tabs.general">Allgemeine Einstellungen</button>
            </div>
            
        <!-- Branding Tab -->
        <div id="branding" class="tab-content active">
            <div class="branding-section">
                <h2 style="font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.branding.title">Branding & Anpassung</h2>
                <p style="color: #6b7280; margin-bottom: 30px; font-weight: 500;" data-i18n="settings.branding.subtitle">Passe Logo, Texte, Farben und Willkommensnachricht an.</p>
                
                <!-- Logo Section -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.branding.logoSection">Logo & Branding</h3>
                    
                    <div class="logo-preview" id="logoPreview">C</div>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 8px; align-items: center;">
                        <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('logoUpload').click()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.branding.uploadLogo">Logo hochladen</button>
                        <button class="btn btn-secondary" onclick="window.resetBrandingLogo()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.branding.resetLogo">Logo zurücksetzen</button>
                    </div>
                    <div class="form-hint" data-i18n="settings.branding.logoHint">Empfohlene Größe: 64×64px (wird automatisch angepasst)</div>
                        </div>
                        
                <!-- Text Customization -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.branding.textCustomization">Text-Anpassungen</h3>
                    
                    <!-- Navigation Text -->
                    <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="margin-bottom: 12px;">
                            <span style="font-size: 16px; font-weight: 600; color: #374151;" data-i18n="settings.branding.navigation">Navigation</span>
                    </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label data-i18n="settings.branding.brandText">Markentext</label>
                            <input type="text" id="brandText" placeholder="Cadillac EV" value="Cadillac EV" style="max-width: 400px;">
                            <div class="form-hint" data-i18n="settings.branding.brandTextHint">Erscheint in der oberen Navigation</div>
                </div>
            </div>
                    
                    <!-- Welcome Message -->
                    <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="margin-bottom: 12px;">
                            <span style="font-size: 16px; font-weight: 600; color: #374151;" data-i18n="settings.branding.welcomeMessage">Willkommensnachricht</span>
                    </div>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label data-i18n="settings.branding.mainTitle">Haupttitel</label>
                                <input type="text" id="welcomeTitle" placeholder="Cadillac EV Assistant" value="Cadillac EV Assistant" style="max-width: 500px;">
                                <div class="form-hint" data-i18n="settings.branding.mainTitleHint">Haupttitel auf der Startseite</div>
                </div>
                
                            <div class="form-group" style="margin-bottom: 0;">
                                <label data-i18n="settings.branding.subtitle">Untertitel</label>
                                <input type="text" id="welcomeSubtitle" placeholder="Ihr persönlicher Assistent für Cadillac Elektrofahrzeuge" value="Ihr persönlicher Assistent für Cadillac Elektrofahrzeuge" style="max-width: 600px;">
                                <div class="form-hint" data-i18n="settings.branding.subtitleHint">Untertitel auf der Startseite</div>
                    </div>
                </div>
                    </div>
                    
                    <!-- Browser Settings -->
                    <div style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="margin-bottom: 12px;">
                            <span style="font-size: 16px; font-weight: 600; color: #374151;" data-i18n="settings.branding.browser">Browser</span>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label data-i18n="settings.branding.pageTitle">Seitentitel</label>
                            <input type="text" id="pageTitle" placeholder="Cadillac EV Assistant" value="Cadillac EV Assistant" style="max-width: 400px;">
                            <div class="form-hint" data-i18n="settings.branding.pageTitleHint">Titel im Browser-Tab</div>
                    </div>
                </div>
            </div>
                
                <!-- Color Scheme -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.branding.colorScheme">Farbschema</h3>
                    
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="form-group" style="width: 200px;">
                            <label data-i18n="settings.branding.primaryColor">Primärfarbe</label>
                            <input type="color" id="primaryColor" value="#3b82f6" style="width: 100%;">
                            <div class="form-hint" data-i18n="settings.branding.primaryColorHint">Hauptfarbe für Buttons und Links</div>
                        </div>

                        <div class="form-group" style="width: 200px;">
                            <label data-i18n="settings.branding.secondaryColor">Sekundärfarbe</label>
                            <input type="color" id="secondaryColor" value="#6b7280" style="width: 100%;">
                            <div class="form-hint" data-i18n="settings.branding.secondaryColorHint">Farbe für sekundäre Elemente</div>
                        </div>
                        
                        <div class="form-group" style="width: 200px;">
                            <label data-i18n="settings.branding.buttonColor">Button-Farbe</label>
                            <input type="color" id="buttonColor" value="#3b82f6" style="width: 100%;">
                            <div class="form-hint" data-i18n="settings.branding.buttonColorHint">Farbe für ALLE Buttons</div>
                        </div>
                    </div>
                    </div>
                    
                <!-- Advanced Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.branding.advancedSettings">Erweiterte Einstellungen</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="showLogoInNav" checked>
                            <span data-i18n="settings.branding.showLogoInNav">Logo in Navigation anzeigen</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="showWelcomeMessage" checked>
                            <span data-i18n="settings.branding.showWelcomeMessage">Willkommensnachricht anzeigen</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="enableAnimations" checked>
                            <span data-i18n="settings.branding.enableAnimations">Animationen aktivieren</span>
                        </label>
                        </div>
                    </div>
                    
                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-top: 32px; align-items: center;">
                    <button class="btn btn-primary" onclick="saveBrandingSettings()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.branding.saveChanges" data-i18n="settings.general.saveChanges">Änderungen speichern</button>
                    <button class="btn btn-secondary" onclick="resetAllBranding()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.branding.resetAll">Alles zurücksetzen</button>
                        </div>
                    </div>
                </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge" class="tab-content">
            <div class="branding-section">
                <h2 style="font-weight: 500; color: #2d2d2d; margin-bottom: 20px;">Wissensdatenbank</h2>
                
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="kbDocCount">0</div>
                        <div class="stat-label" data-i18n="settings.knowledgeDb.documents">Dokumente</div>
                        <div class="stat-description">Wissensdatenbank</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="kbTotalSize">0 MB</div>
                        <div class="stat-label" data-i18n="settings.knowledgeDb.totalSize">Gesamtgröße</div>
                        <div class="stat-description" data-i18n="settings.knowledgeDb.allFiles">Alle Dateien</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="kbLastUpdate">-</div>
                        <div class="stat-label" data-i18n="settings.knowledgeDb.lastUpdate">Letzte Aktualisierung</div>
                        <div class="stat-description">Wissensdatenbank</div>
                    </div>
                </div>
                
                <script>
                // FORCE LOAD AND DISPLAY KNOWLEDGE BASE - SELF-CONTAINED
                (function() {
                    const formatSize = (bytes) => {
                        if (!bytes) return '0 B';
                        const k = 1024;
                        const sizes = ['B', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                    };
                    
                    const formatDate = (date) => {
                        if (!date) return '-';
                        
                        // Handle Firestore Timestamp objects
                        let timestamp;
                        if (typeof date === 'object') {
                            if (date._seconds) {
                                timestamp = date._seconds * 1000;
                            } else if (date.seconds) {
                                timestamp = date.seconds * 1000;
                            } else if (date.toDate) {
                                timestamp = date.toDate().getTime();
                            } else {
                                timestamp = new Date(date).getTime();
                            }
                        } else {
                            timestamp = new Date(date).getTime();
                        }
                        
                        const d = new Date(timestamp);
                        if (isNaN(d.getTime())) return '-';
                        return d.toLocaleDateString('de-DE');
                    };
                    
                    fetch('https://us-central1-cis-de.cloudfunctions.net/knowledgebase?t=' + Date.now())
                        .then(r => r.json())
                        .then(data => {
                            const docs = data.documents || [];
                            document.getElementById('kbDocCount').textContent = docs.length;
                            const size = docs.reduce((sum, doc) => sum + (doc.size || 0), 0);
                            document.getElementById('kbTotalSize').textContent = (size / (1024 * 1024)).toFixed(2) + ' MB';
                            console.log('✅ KB Inline: Loaded ' + docs.length + ' documents');
                            
                            // Store documents globally
                            window.knowledgeBase = docs;
                            
                            // Render documents directly
                            const kbList = document.getElementById('kbList');
                            if (!kbList) {
                                console.error('❌ kbList element not found!');
                                return;
                            }
                            
                            if (docs.length === 0) {
                                kbList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><span data-i18n="settings.knowledgeDb.noDocuments">Keine Dokumente gefunden</span></div>';
                                return;
                            }
                            
                            console.log('✅ KB Inline: Loading ' + docs.length + ' documents into kb-functions...');
                            
                            // Update last updated
                            if (docs.length > 0) {
                                const timestamps = docs.map(d => {
                                    const ts = d.uploadedAt;
                                    if (typeof ts === 'number') return ts;
                                    if (ts && ts.seconds) return ts.seconds * 1000;
                                    if (ts && ts._seconds) return ts._seconds * 1000;
                                    return 0;
                                });
                                const lastUpdated = Math.max(...timestamps);
                                if (lastUpdated > 0) {
                                    const lastUpdatedEl = document.getElementById('kbLastUpdate');
                                    if (lastUpdatedEl) {
                                        lastUpdatedEl.textContent = formatDate(lastUpdated);
                                    }
                                }
                            }
                            
                            // Use the new kb-functions.js to render with pagination
                            if (typeof window.loadKbDocuments === 'function') {
                                window.loadKbDocuments(docs);
                            } else {
                                console.error('❌ loadKbDocuments function not found!');
                            }
                        })
                        .catch(e => console.error('KB Inline Error:', e));
                })();
                </script>
                    
                <!-- Toolbar -->
                <div class="kb-toolbar">
                    <!-- Search Row -->
                    <div class="kb-search">
                        <input type="text" id="kbSearch" class="kb-search-input" data-i18n-placeholder="settings.knowledgeDb.searchPlaceholder" placeholder="Dokumente durchsuchen...">
                        <select id="kbFilter" class="kb-filter">
                            <option value="" data-i18n="settings.knowledgeDb.allCategories">Alle Kategorien</option>
                            <option value="PDF">PDF</option>
                            <option value="TXT">TXT</option>
                            <option value="MD">Markdown</option>
                            <option value="XLSX">Excel</option>
                        </select>
                        <select id="kbSort" class="kb-sort">
                            <option value="newest" data-i18n="settings.knowledgeDb.sortNewest">Neueste zuerst</option>
                            <option value="oldest" data-i18n="settings.knowledgeDb.sortOldest">Älteste zuerst</option>
                            <option value="name" data-i18n="settings.knowledgeDb.sortName">Nach Name</option>
                            <option value="size" data-i18n="settings.knowledgeDb.sortSize">Nach Größe</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshKnowledgeBase()" data-i18n="settings.knowledgeDb.refresh">Aktualisieren</button>
                </div>

                    <!-- Bulk Actions Bar -->
                    <div class="kb-bulk-actions">
                        <div class="kb-select-all">
                            <input type="checkbox" id="selectAllKb">
                            <label for="selectAllKb" data-i18n="settings.knowledgeDb.selectAll">Alle auswählen</label>
                        </div>
                        <div class="kb-bulk-actions-right">
                            <span class="kb-selected-count"><span id="selectedCount">0</span> <span data-i18n="settings.knowledgeDb.selected">ausgewählt</span></span>
                            <button class="btn btn-secondary" id="bulkDeleteKbBtn" disabled style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.knowledgeDb.deleteSelected">Ausgewählte löschen</button>
                            <button class="btn btn-secondary" id="exportKbBtn" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.knowledgeDb.export">Exportieren</button>
                            <button class="btn btn-secondary" id="importKbBtn" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.knowledgeDb.import">Importieren</button>
                    </div>
                    </div>
                </div>

                <!-- Document List -->
                <div id="kbList">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Technical Database Tab -->
        <div id="technical" class="tab-content">
            <div class="branding-section">
                <h2 style="font-weight: 500; color: #2d2d2d; margin-bottom: 20px;">Technische Datenbank</h2>
                
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="tdDocCount">0</div>
                        <div class="stat-label" data-i18n="settings.technicalDb.documents">Dokumente</div>
                        <div class="stat-description" data-i18n="settings.technicalDb.technicalDatabase">Technische Datenbank</div>
                            </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tdTotalSize">0 KB</div>
                        <div class="stat-label" data-i18n="settings.technicalDb.totalSize">Gesamtgröße</div>
                        <div class="stat-description" data-i18n="settings.technicalDb.allFiles">Alle Dateien</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tdLastUpdated">-</div>
                        <div class="stat-label" data-i18n="settings.technicalDb.lastUpdate">Letzte Aktualisierung</div>
                        <div class="stat-description" data-i18n="settings.technicalDb.technicalDatabase">Technische Datenbank</div>
                    </div>
                </div>
                
                <script>
                // FORCE LOAD TECHNICAL DATABASE IMMEDIATELY - INLINE SCRIPT
                (function() {
                    fetch('https://us-central1-cis-de.cloudfunctions.net/technicalDatabase?t=' + Date.now())
                        .then(r => r.json())
                        .then(data => {
                            const docs = data.documents || [];
                            document.getElementById('tdDocCount').textContent = docs.length;
                            const size = docs.reduce((sum, doc) => sum + (doc.size || 0), 0);
                            document.getElementById('tdTotalSize').textContent = (size / (1024 * 1024)).toFixed(2) + ' MB';
                            
                            // Update last updated
                            const lastUpdated = docs.length > 0 ? Math.max(...docs.map(d => d.uploadedAt?.seconds || d.uploadedAt?._seconds || 0)) : null;
                            if (lastUpdated) {
                                const d = new Date(lastUpdated * 1000);
                                document.getElementById('tdLastUpdated').textContent = d.toLocaleDateString('de-DE');
                            }
                            
                            console.log('✅ Tech Inline: Loaded ' + docs.length + ' documents');
                            
                            // Wait for loadTdDocuments function to be available
                            const loadDocs = function() {
                                if (typeof window.loadTdDocuments === 'function') {
                                    window.loadTdDocuments(docs);
                                    console.log('✅ Tech Inline: Displayed documents');
                                } else {
                                    console.log('⏳ Tech Inline: Waiting for loadTdDocuments...');
                                    setTimeout(loadDocs, 100);
                                }
                            };
                            loadDocs();
                        })
                        .catch(e => console.error('Tech Inline Error:', e));
                })();
                </script>

                <!-- Toolbar -->
                <div class="kb-toolbar">
                    <!-- Search Row -->
                    <div class="kb-search">
                        <input type="text" id="tdSearch" class="kb-search-input" data-i18n-placeholder="settings.technicalDb.searchPlaceholder" placeholder="Technische Dokumente durchsuchen...">
                        <select id="tdFilter" class="kb-filter">
                            <option value="" data-i18n="settings.technicalDb.allCategories">Alle Kategorien</option>
                            <option value="PDF">PDF</option>
                            <option value="TXT">TXT</option>
                            <option value="MD">Markdown</option>
                            <option value="XLSX">Excel</option>
                        </select>
                        <select id="tdSort" class="kb-sort">
                            <option value="newest" data-i18n="settings.technicalDb.sortNewest">Neueste zuerst</option>
                            <option value="oldest" data-i18n="settings.technicalDb.sortOldest">Älteste zuerst</option>
                            <option value="name" data-i18n="settings.technicalDb.sortName">Nach Name</option>
                            <option value="size" data-i18n="settings.technicalDb.sortSize">Nach Größe</option>
                        </select>
                        <button class="btn btn-primary" onclick="refreshTechnicalDatabase()" data-i18n="settings.technicalDb.refresh">Aktualisieren</button>
                        </div>

                    <!-- Bulk Actions Bar -->
                    <div class="kb-bulk-actions">
                        <div class="kb-select-all">
                            <input type="checkbox" id="selectAllTd">
                            <label for="selectAllTd" data-i18n="settings.technicalDb.selectAll">Alle auswählen</label>
                            </div>
                        <div class="kb-bulk-actions-right">
                            <span class="kb-selected-count"><span id="tdSelectedCount">0</span> <span data-i18n="settings.technicalDb.selected">ausgewählt</span></span>
                            <button class="btn btn-secondary" id="bulkDeleteTdBtn" disabled style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.technicalDb.deleteSelected">Ausgewählte löschen</button>
                            <button class="btn btn-secondary" id="exportTdBtn" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.technicalDb.export">Exportieren</button>
                            <button class="btn btn-secondary" id="importTdBtn" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important; box-sizing: border-box !important; margin: 0 !important;" data-i18n="settings.technicalDb.import">Importieren</button>
                        </div>
                            </div>
                        </div>

                <!-- Document List -->
                <div id="tdList">
                    <!-- Documents will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <div id="tdPagination">
                    <!-- Pagination will be rendered here -->
                </div>
            </div>
        </div>

        <!-- General Settings Tab -->
        <div id="general" class="tab-content">
            <div class="branding-section">
                <h2 style="font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.title">Allgemeine Einstellungen</h2>
                <p style="color: #6b7280; margin-bottom: 30px; font-weight: 500;" data-i18n="settings.general.subtitle">Verwalten Sie System-Einstellungen und erweiterte Tools.</p>
                
                <!-- System Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.systemSettings">System-Einstellungen</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.language">Sprache</label>
                        <select id="languageSetting" onchange="window.changeLanguage(this.value)" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="de">Deutsch</option>
                            <option value="en">English</option>
                            <option value="fr">Français</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.timezone">Zeitzone</label>
                        <select id="timezoneSetting" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="Europe/Zurich" selected>Europe/Zurich (GMT+1) - Schweiz</option>
                            <option value="Europe/Berlin">Europe/Berlin (GMT+1)</option>
                            <option value="Europe/London">Europe/London (GMT+0)</option>
                            <option value="America/New_York">America/New_York (GMT-5)</option>
                            <option value="America/Los_Angeles">America/Los_Angeles (GMT-8)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.dateFormat">Datumsformat</label>
                        <select id="dateFormatSetting" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="DD.MM.YYYY">DD.MM.YYYY (26.10.2025)</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY (10/26/2025)</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD (2025-10-26)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="notificationsSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableNotifications">Benachrichtigungen aktivieren</span>
                        </label>
                    </div>
                </div>
                
                <!-- Chat Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.aiModelConfig">KI-Modell Konfiguration</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.primaryModel">Primäres KI-Modell</label>
                        <select id="chatModelSetting" onchange="window.updateModelConfig(this.value)" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="gpt-4.1-mini">GPT-4.1 Mini (Empfohlen)</option>
                            <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            <option value="custom">Custom Model (Server-gehostet)</option>
                        </select>
                    </div>
                    
                    <div id="customModelConfig" style="display: none; margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 6px;">
                        <h4 style="font-size: 16px; font-weight: 500; margin-bottom: 10px;" data-i18n="settings.general.customModelConfig">Custom Model Konfiguration</h4>
                        <div class="form-group">
                            <label data-i18n="settings.general.modelName">Model Name</label>
                            <input type="text" id="customModelName" data-i18n-placeholder="settings.general.modelNamePlaceholder" placeholder="z.B. my-llama-3" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label data-i18n="settings.general.apiEndpoint">API Endpoint</label>
                            <input type="text" id="customModelEndpoint" data-i18n-placeholder="settings.general.apiEndpointPlaceholder" placeholder="https://your-server.com/v1" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label data-i18n="settings.general.apiKey">API Key</label>
                            <input type="password" id="customModelKey" data-i18n-placeholder="settings.general.apiKeyPlaceholder" placeholder="Your API Key" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; width: 100%;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.databaseAccess">Datenbank-Zugriff</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 400;">
                                <input type="checkbox" id="accessKnowledgeDB" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span data-i18n="settings.general.accessKnowledgeDb">Zugriff auf Wissensdatenbank</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 400;">
                                <input type="checkbox" id="accessTechnicalDB" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span data-i18n="settings.general.accessTechnicalDb">Zugriff auf Technische Datenbank</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.temperature">Temperatur (Kreativität)</label>
                        <input type="range" id="chatTemperatureSetting" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('temperatureValue').textContent = this.value" style="max-width: 400px; width: 100%;">
                        <span id="temperatureValue" style="color: #6b7280; font-size: 14px;">0.7</span>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.maxTokens">Max Tokens</label>
                        <input type="number" id="chatMaxTokensSetting" value="2000" min="100" max="8000" step="100" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.chatSystemPrompt">System Prompt (Chat-Seite)</label>
                        <textarea id="chatSystemPromptSetting" rows="4" data-i18n-placeholder="settings.general.chatSystemPromptPlaceholder" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; font-family: inherit;">Du bist ein hilfreicher Cadillac EV Assistent mit Zugriff auf die Wissensdatenbank und technische Datenbank. Beantworte Fragen zu Cadillac Elektrofahrzeugen präzise, freundlich und professionell. Nutze die verfügbaren Dokumente, um genaue Informationen zu liefern. Wenn du etwas nicht weißt, sage es ehrlich.</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.troubleshootingSystemPrompt">System Prompt (Troubleshooting-Seite)</label>
                        <textarea id="troubleshootingSystemPromptSetting" rows="4" data-i18n-placeholder="settings.general.troubleshootingSystemPromptPlaceholder" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; font-family: inherit;">Du bist ein technischer Support-Assistent für Cadillac Elektrofahrzeuge. Deine Aufgabe ist es, technische Probleme zu diagnostizieren und Lösungen bereitzustellen. Nutze die technische Datenbank für präzise Anleitungen. Frage systematisch nach Symptomen, prüfe mögliche Ursachen und biete Schritt-für-Schritt-Lösungen an.</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="chatStreamingSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableStreaming">Streaming aktivieren (Echtzeit-Antworten)</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="chatHistorySetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.saveChatHistory">Chat-Verlauf speichern</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="unifiedWorkflowSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.unifiedWorkflow">Einheitlicher Workflow (Alle Modelle zusammenarbeiten lassen)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Database Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.databaseSettings">Datenbank-Einstellungen</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.autoBackupInterval">Auto-Backup Intervall</label>
                        <select id="dbAutoBackupSetting" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="never">Nie</option>
                            <option value="daily">Täglich</option>
                            <option value="weekly">Wöchentlich</option>
                            <option value="monthly">Monatlich</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.maxFileSize">Maximale Dateigröße (MB)</label>
                        <input type="number" id="dbMaxFileSizeSetting" value="50" min="1" max="500" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.allowedFileTypes">Erlaubte Dateitypen</label>
                        <input type="text" id="dbAllowedTypesSetting" value="pdf,txt,md,docx,xlsx" placeholder="pdf,txt,md,docx" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="dbDuplicateDetectionSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableDuplicateDetection">Duplikat-Erkennung aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="dbAutoCategorySetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.autoCategor">Automatische Kategorisierung</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="window.createBackup()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.createBackup">Backup erstellen</button>
                        <button class="btn btn-secondary" onclick="window.restoreBackup()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.restoreBackup">Backup wiederherstellen</button>
                        <button class="btn btn-secondary" onclick="window.clearCache()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.clearCache">Cache leeren</button>
                        <button class="btn" onclick="window.deleteAllData()" style="background: #ef4444; color: white; height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.deleteAllData">Alle Daten löschen</button>
                    </div>
                </div>
                
                <!-- API Settings -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin: 0;" data-i18n="settings.general.apiSettings">API-Einstellungen (Mehrere API Keys)</h3>
                        <button onclick="window.addApiKeyField()" style="background: #3b82f6; color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px;">+</button>
                    </div>
                    
                    <div id="apiKeysContainer">
                        <div class="api-key-group" style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 6px; position: relative;">
                            <button onclick="window.removeApiKeyField(this)" style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">×</button>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label>Provider Name</label>
                                <input type="text" class="api-provider-name" placeholder="z.B. OpenAI, Gemini, Custom" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label>KI-Modell</label>
                                <input type="text" class="api-model-name" placeholder="z.B. gpt-4.1-mini, gemini-2.5-flash" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            </div>
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" class="api-key-value" placeholder="Your API Key" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.apiTimeout">API Timeout (Sekunden)</label>
                        <input type="number" id="apiTimeoutSetting" value="30" min="5" max="120" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.rateLimit">Rate Limit (Anfragen pro Minute)</label>
                        <input type="number" id="apiRateLimitSetting" value="60" min="1" max="1000" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.retryAttempts">Retry-Versuche bei Fehler</label>
                        <input type="number" id="apiRetryCountSetting" value="3" min="0" max="10" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.securitySettings">Sicherheit & Benutzer</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.sessionTimeout">Sitzungs-Timeout (Minuten)</label>
                        <input type="number" id="securitySessionTimeoutSetting" value="60" min="5" max="1440" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="security2FASetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enable2FA">Zwei-Faktor-Authentifizierung aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="securityActivityLogSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableActivityLog">Aktivitäts-Log aktivieren</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="window.changePassword()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.changePassword">Passwort ändern</button>
                        <button class="btn btn-secondary" onclick="window.viewActivityLog()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.viewActivityLog">Aktivitäts-Log anzeigen</button>
                    </div>
                </div>
                
                <!-- Performance Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.performanceSettings">Performance & Optimierung</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.cacheSize">Cache-Größe (MB)</label>
                        <input type="number" id="perfCacheSizeSetting" value="100" min="10" max="1000" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="perfLazyLoadingSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableLazyLoading">Lazy Loading aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="perfImageCompressionSetting" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableImageCompression">Bildkompression aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="perfPrefetchingSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enablePrefetching">Prefetching aktivieren</span>
                        </label>
                    </div>
                </div>
                
                <!-- Notification Settings -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.notificationSettings">Benachrichtigungen</h3>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.notificationEmail">E-Mail-Adresse für Benachrichtigungen</label>
                        <input type="email" id="notifEmailSetting" placeholder="ihre@email.de" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="notifEmailEnabledSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableEmailNotifications">E-Mail-Benachrichtigungen aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="notifPushEnabledSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enablePushNotifications">Push-Benachrichtigungen aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.notificationFrequency">Benachrichtigungs-Frequenz</label>
                        <select id="notifFrequencySetting" style="max-width: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                            <option value="instant">Sofort</option>
                            <option value="hourly">Stündlich</option>
                            <option value="daily">Täglich</option>
                            <option value="weekly">Wöchentlich</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Tools -->
                <div style="margin-bottom: 30px;">
                    <h3 style="font-size: 18px; font-weight: 500; color: #2d2d2d; margin-bottom: 20px;" data-i18n="settings.general.advancedTools">Erweiterte Tools</h3>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="debugModeSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableDebugMode">Debug-Modus aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="analyticsSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableAnalytics">Analytics aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                            <input type="checkbox" id="webhookEnabledSetting" style="width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="settings.general.enableWebhook">Webhook-Integration aktivieren</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.webhookUrl">Webhook URL</label>
                        <input type="url" id="webhookUrlSetting" placeholder="https://..." style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="settings.general.customCss">Custom CSS</label>
                        <textarea id="customCSSSetting" rows="4" placeholder="/* Ihr eigenes CSS */" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: 'Courier New', monospace;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="window.viewLogs()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.viewLogs">Logs anzeigen</button>
                        <button class="btn btn-secondary" onclick="window.exportSettings()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.exportSettings">Einstellungen exportieren</button>
                        <button class="btn btn-secondary" onclick="window.importSettings()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.importSettings">Einstellungen importieren</button>
                        <button class="btn btn-secondary" onclick="window.testWebhook()" style="height: 44px !important; min-height: 44px !important; padding: 0 20px !important;" data-i18n="settings.general.testWebhook">Webhook testen</button>
                    </div>
                </div>
                
                <!-- Save Buttons - ALIGNED -->
                <div style="display: flex; gap: 12px; align-items: center; justify-content: flex-start; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="window.saveGeneralSettings()" style="height: 44px; line-height: 44px; padding: 0 24px; font-size: 16px; display: inline-flex; align-items: center; justify-content: center;">Änderungen speichern</button>
                    <button class="btn btn-secondary" onclick="window.resetGeneralSettings()" style="height: 44px; line-height: 44px; padding: 0 24px; font-size: 16px; display: inline-flex; align-items: center; justify-content: center;" data-i18n="settings.general.reset">Zurücksetzen</button>
                </div>
            </div>
        </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dokument löschen</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
                    </div>
            <div class="modal-body">
                <p>Möchten Sie dieses Dokument wirklich löschen?</p>
                <p><strong id="deleteDocName"></strong></p>
                <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; align-items: center;">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">Abbrechen</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">Löschen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js?v=1730000010"></script>
    <script>
        // Notification functions - Define FIRST to be available globally
        window.showMessage = function(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        };
        
        // Theme toggle functions - Define early for global availability
        window.initializeTheme = async function() {
            try {
                const user = firebase.auth().currentUser;
                let savedTheme = 'light';
                if (user) {
                    const doc = await firebase.firestore().collection('settings').doc(user.uid).get();
                    savedTheme = doc.exists && doc.data().theme ? doc.data().theme : 'light';
                }
                document.documentElement.setAttribute('data-theme', savedTheme);
                document.body.setAttribute('data-theme', savedTheme);
                console.log('✅ Theme initialized:', savedTheme);
            } catch (error) {
                console.error('Theme init error:', error);
                document.documentElement.setAttribute('data-theme', 'light');
                document.body.setAttribute('data-theme', 'light');
            }
        };
        
        window.toggleTheme = async function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            document.body.setAttribute('data-theme', newTheme);
            
            try {
                const user = firebase.auth().currentUser;
                if (user) {
                    await firebase.firestore().collection('settings').doc(user.uid).set({
                        theme: newTheme,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }
            } catch (error) {
                console.error('Theme save error:', error);
            }
            
            console.log('✅ Theme toggled to:', newTheme);
        };
        
        // Language switching function - Uses i18n system
        window.changeLanguage = function(lang) {
            if (window.i18n) {
                window.i18n.changeLanguage(lang);
            } else {
                console.error('i18n system not loaded');
            }
        };
        
        // Get language from cookie
        window.getLanguage = function() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'app_language') {
                    return value;
                }
            }
            return 'de'; // Default to German
        };
        
        // Model configuration function
        window.updateModelConfig = function(model) {
            const customConfig = document.getElementById('customModelConfig');
            if (model === 'custom') {
                customConfig.style.display = 'block';
            } else {
                customConfig.style.display = 'none';
            }
        };
        
        // Add API Key Field
        window.addApiKeyField = function() {
            const container = document.getElementById('apiKeysContainer');
            const newField = document.createElement('div');
            newField.className = 'api-key-group';
            newField.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 6px; position: relative;';
            newField.innerHTML = `
                <button onclick="window.removeApiKeyField(this)" style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">×</button>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label>Provider Name</label>
                    <input type="text" class="api-provider-name" placeholder="z.B. OpenAI, Gemini, Custom" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label>KI-Modell</label>
                    <input type="text" class="api-model-name" placeholder="z.B. gpt-4.1-mini, gemini-2.5-flash" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" class="api-key-value" placeholder="Your API Key" style="max-width: 600px; width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                </div>
            `;
            container.appendChild(newField);
            window.showMessage('API Key Feld hinzugefügt', 'success');
        };
        
        // Remove API Key Field
        window.removeApiKeyField = function(button) {
            const container = document.getElementById('apiKeysContainer');
            if (container.children.length <= 1) {
                window.showMessage('Mindestens ein API Key Feld muss vorhanden sein', 'error');
                return;
            }
            button.closest('.api-key-group').remove();
            window.showMessage('API Key Feld entfernt', 'success');
        };
        
        // ===== GENERAL SETTINGS FUNCTIONS - Define early for global availability =====
        
        // Save general settings
        window.saveGeneralSettings = function() {
            const settings = {
                language: document.getElementById('languageSetting').value,
                timezone: document.getElementById('timezoneSetting').value,
                dateFormat: document.getElementById('dateFormatSetting').value,
                notifications: document.getElementById('notificationsSetting').checked,
                debugMode: document.getElementById('debugModeSetting').checked,
                analytics: document.getElementById('analyticsSetting').checked
            };
            // Settings saved to Firestore via saveGeneralSettings
            window.showMessage('Änderungen erfolgreich gespeichert!', 'success');
        };
        
        // Reset general settings
        window.resetGeneralSettings = function() {
            if (confirm('Möchten Sie alle Einstellungen zurücksetzen?')) {
                // Settings cleared from Firestore
                window.showMessage('Einstellungen zurückgesetzt', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        };
        
        // Create backup
        window.createBackup = function() {
            const backup = {
                branding: JSON.parse('{}'  // TODO: Load from Firestore || '{}'),
                general: JSON.parse('{}'  // TODO: Load from Firestore || '{}'),
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cis-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            window.showMessage('Backup erfolgreich erstellt!', 'success');
        };
        
        // Restore backup
        window.restoreBackup = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (backup.branding) // Branding restored from Firestore
                        if (backup.general) // General settings restored from Firestore
                        window.showMessage('Backup erfolgreich wiederhergestellt!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } catch (error) {
                        window.showMessage('Fehler beim Wiederherstellen des Backups', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };
        
        // Clear cache
        window.clearCache = function() {
            if (confirm('Möchten Sie den Cache wirklich leeren?')) {
                // KB cache cleared
                // TD cache cleared
                window.showMessage('Cache erfolgreich geleert!', 'success');
            }
        };
        
        // Delete all data
        window.deleteAllData = function() {
            if (confirm('ACHTUNG: Alle Daten werden gelöscht! Dies kann nicht rückgängig gemacht werden. Fortfahren?')) {
                if (confirm('Sind Sie WIRKLICH sicher? Alle Einstellungen und Daten gehen verloren!')) {
                    // All data cleared from Firestore
                    window.showMessage('Alle Daten wurden gelöscht', 'success');
                    setTimeout(() => location.reload(), 1500);
                }
            }
        };
        
        // View logs
        window.viewLogs = function() {
            const logs = 'Logs werden in Firestore gespeichert'  // TODO: Load from Firestore || 'Keine Logs verfügbar';
            alert('System Logs:\n\n' + logs);
        };
        
        // Export settings
        window.exportSettings = function() {
            const settings = {
                branding: JSON.parse('{}'  // TODO: Load from Firestore || '{}'),
                general: JSON.parse('{}'  // TODO: Load from Firestore || '{}'),
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cis-settings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            window.showMessage('Einstellungen erfolgreich exportiert!', 'success');
        };
        
        // Import settings
        window.importSettings = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const settings = JSON.parse(event.target.result);
                        if (settings.branding) {} // Branding saved to Firestore
                        if (settings.general) {} // General settings saved to Firestore
                        window.showMessage('Einstellungen erfolgreich importiert!', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } catch (error) {
                        window.showMessage('Fehler beim Importieren der Einstellungen', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };
        
        // IMMEDIATE logo loading - no delays, no events
        (function() {
            console.log('🔄 IMMEDIATE: Loading branding settings...');
            fetch('https://us-central1-cis-de.cloudfunctions.net/branding')
                .then(response => response.json())
                .then(data => {
                    console.log('🔄 IMMEDIATE: Got branding data:', data);
                    if (data.branding && data.branding.logo) {
                        const logoPreview = document.getElementById('logoPreview');
                        if (logoPreview) {
                            logoPreview.innerHTML = `<img src="${data.branding.logo}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">`;
                            console.log('✅ IMMEDIATE: Logo loaded successfully');
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ IMMEDIATE: Error loading branding:', error);
                });
        })();
    </script>
    <script>
        // Load branding settings function - Define at the very top
        window.loadBrandingSettings = async function() {
            try {
                console.log('🔄 loadBrandingSettings function called - Loading branding settings from database...');
                
                // Try to load from database first
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding');
                
                if (response.ok) {
                    const result = await response.json();
                    const settings = result.branding;
                    console.log('Loaded branding settings from database:', settings);
                    
                    // Load form values
                    const brandText = document.getElementById('brandText');
                    if (brandText) brandText.value = settings.brandText || 'Cadillac EV';
                    
                    const welcomeTitle = document.getElementById('welcomeTitle');
                    if (welcomeTitle) welcomeTitle.value = settings.welcomeTitle || 'Cadillac EV Assistant';
                    
                    const welcomeSubtitle = document.getElementById('welcomeSubtitle');
                    if (welcomeSubtitle) welcomeSubtitle.value = settings.welcomeSubtitle || 'Ihr persönlicher Assistent für Cadillac Elektrofahrzeuge';
                    
                    const pageTitle = document.getElementById('pageTitle');
                    if (pageTitle) pageTitle.value = settings.pageTitle || 'Cadillac EV Assistant';
                    
                    const primaryColor = document.getElementById('primaryColor');
                    if (primaryColor) primaryColor.value = settings.primaryColor || '#3b82f6';
                    
                    const secondaryColor = document.getElementById('secondaryColor');
                    if (secondaryColor) secondaryColor.value = settings.secondaryColor || '#6b7280';
                    
                    const buttonColor = document.getElementById('buttonColor');
                    if (buttonColor) buttonColor.value = settings.buttonColor || '#3b82f6';
                    
                    // Load checkboxes
                    const showLogoInNav = document.getElementById('showLogoInNav');
                    if (showLogoInNav) showLogoInNav.checked = settings.showLogoInNav !== false;
                    
                    const showWelcomeMessage = document.getElementById('showWelcomeMessage');
                    if (showWelcomeMessage) showWelcomeMessage.checked = settings.showWelcomeMessage !== false;
                    
                    const enableAnimations = document.getElementById('enableAnimations');
                    if (enableAnimations) enableAnimations.checked = settings.enableAnimations !== false;
                    
                    // Load logo
                    const logoPreview = document.getElementById('logoPreview');
                    console.log('🔄 Loading logo:', {
                        logoPreview: !!logoPreview,
                        hasLogo: !!settings.logo,
                        logoLength: settings.logo ? settings.logo.length : 'null'
                    });
                    
                    if (logoPreview && settings.logo) {
                        logoPreview.innerHTML = `<img src="${settings.logo}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">`;
                        console.log('✅ Logo loaded and displayed in preview');
                    } else if (logoPreview) {
                        logoPreview.innerHTML = 'C';
                        console.log('✅ Default logo "C" displayed (no saved logo)');
                    } else {
                        console.error('❌ Logo preview element not found');
                    }
                    
                    // Apply branding immediately
                    if (typeof window.applyBrandingToNavigation === 'function') {
                        window.applyBrandingToNavigation();
                    }
                    
                    console.log('Branding settings loaded from database successfully');
                } else {
                    throw new Error('Failed to load from database');
                }
            } catch (error) {
                console.error('Error loading branding settings from database:', error);
                
                // Show error message
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Fehler beim Laden der Einstellungen', 'error');
                }
            }
        };

        // Tab switching function - Define immediately
        window.switchSettingsTab = function(tabName) {
            console.log('🔄 Switching to tab:', tabName);
            
            // Remove active class from all tabs
            const allTabs = document.querySelectorAll('.settings-tab');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // Hide all tab content
            const allContent = document.querySelectorAll('.tab-content');
            allContent.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Activate selected tab
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Show selected content
            const selectedContent = document.getElementById(tabName);
            if (selectedContent) {
                selectedContent.classList.add('active');
                selectedContent.style.display = 'block';
            }
            
            // Initialize tab-specific functionality
            if (tabName === 'knowledge') {
                console.log('📚 Initializing knowledge base...');
                if (typeof window.loadKnowledgeBase === 'function') {
                    window.loadKnowledgeBase();
                }
            } else if (tabName === 'technical') {
                console.log('🔧 Initializing technical database...');
                if (typeof window.loadTechnicalDatabase === 'function') {
                    window.loadTechnicalDatabase();
                }
            }
            
            console.log('✅ Tab switched to:', tabName);
        };
        
        // Logo reset function - Define immediately
        window.resetLogoDirect = async function() {
            try {
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    logoPreview.innerHTML = 'C';
                    logoPreview.style.backgroundImage = '';
                    console.log('Logo reset successfully');
                }
                
                // Update database to remove logo and set background to dark
                const settings = await getCurrentBrandingSettings();
                settings.logo = null;
                settings.logoBackgroundTransparent = false;
                
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    // Apply branding to navigation immediately
                    applyBrandingToNavigation();
                    console.log('✅ Logo reset saved to database');
                }
            } catch (error) {
                console.error('Error resetting logo:', error);
            }
        };
        
        // Get current branding settings from database
        async function getCurrentBrandingSettings() {
            try {
                console.log('🔄 Loading current branding settings from database...');
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding');
                console.log('📡 GET response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Loaded branding settings:', {
                        hasLogo: !!result.branding?.logo,
                        logoLength: result.branding?.logo ? result.branding.logo.length : 'null',
                        keys: Object.keys(result.branding || {})
                    });
                    return result.branding || {};
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to load branding settings:', response.status, errorText);
                    throw new Error(`Failed to load branding settings: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Error loading branding settings:', error);
                return {};
            }
        }

        // Logo upload function - Define immediately
        window.handleLogoUploadDirect = async function(input) {
            console.log('🔄 Logo upload started...');
            const file = input.files[0];
            if (!file) {
                console.log('❌ No file selected');
                return;
            }

            console.log('📁 File selected:', file.name, 'Size:', file.size, 'Type:', file.type);

            if (!file.type.startsWith('image/')) {
                console.error('❌ Invalid file type:', file.type);
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Bitte wählen Sie eine Bilddatei aus', 'error');
                } else {
                    console.error('Bitte wählen Sie eine Bilddatei aus');
                }
                return;
            }

            // Check file size (limit to 5MB for base64 encoding)
            if (file.size > 5 * 1024 * 1024) {
                console.error('❌ File too large:', file.size, 'bytes');
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Datei ist zu groß. Bitte wählen Sie eine kleinere Datei (< 5MB)', 'error');
                } else {
                    console.error('Datei ist zu groß');
                }
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const dataURL = e.target.result;
                    console.log('📖 File read successfully, dataURL length:', dataURL.length);
                    
                    // Update logo preview
                    const logoPreview = document.getElementById('logoPreview');
                    if (logoPreview) {
                        logoPreview.innerHTML = `<img src="${dataURL}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">`;
                        console.log('✅ Logo preview updated');
                    }
                    
                    // Get current branding settings from database
                    const settings = await getCurrentBrandingSettings();
                    settings.logo = dataURL;
                    settings.logoBackgroundTransparent = true; // Save background state
                    console.log('💾 Logo set in settings, length:', settings.logo ? settings.logo.length : 'null');
                    
                    // Save to database
                    try {
                        console.log('🔄 Sending logo to database...', {
                            logoLength: settings.logo ? settings.logo.length : 'null',
                            logoBackgroundTransparent: settings.logoBackgroundTransparent,
                            settingsKeys: Object.keys(settings)
                        });
                        
                        const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(settings)
                        });
                        
                        console.log('📡 Database response status:', response.status);
                        console.log('📡 Database response ok:', response.ok);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('✅ Logo saved to database successfully:', result);
                            
                            // Verify the logo was actually saved by fetching it back
                            console.log('🔄 Verifying logo was saved...');
                            const verifyResponse = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding');
                            if (verifyResponse.ok) {
                                const verifyResult = await verifyResponse.json();
                                console.log('✅ Logo verification:', {
                                    hasLogo: !!verifyResult.branding?.logo,
                                    logoLength: verifyResult.branding?.logo ? verifyResult.branding.logo.length : 'null'
                                });
                            }
                            
                            // Apply branding immediately to navigation
                            console.log('🔄 Applying branding to navigation...');
                            await applyBrandingToNavigation();
                            
                            if (typeof window.showMessage === 'function') {
                                window.showMessage('Logo erfolgreich hochgeladen', 'success');
                            }
                        } else {
                            const errorText = await response.text();
                            console.error('❌ Database response error:', response.status, errorText);
                            throw new Error(`Failed to save logo to database: ${response.status} ${errorText}`);
                        }
                    } catch (dbError) {
                        console.error('❌ Error saving logo to database:', dbError);
                        
                        if (typeof window.showMessage === 'function') {
                            window.showMessage('Fehler beim Speichern des Logos', 'error');
                        }
                    }
                } catch (error) {
                    console.error('❌ Error handling logo upload:', error);
                    if (typeof window.showMessage === 'function') {
                        window.showMessage('Fehler beim Hochladen des Logos', 'error');
                    }
                }
            };
            reader.readAsDataURL(file);
        };
        
        // Save branding settings function - Define immediately
        window.saveBrandingSettings = async function() {
            try {
                const settings = {
                    brandText: document.getElementById('brandText').value,
                    welcomeTitle: document.getElementById('welcomeTitle').value,
                    welcomeSubtitle: document.getElementById('welcomeSubtitle').value,
                    pageTitle: document.getElementById('pageTitle').value,
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    buttonColor: document.getElementById('buttonColor').value,
                    showLogoInNav: document.getElementById('showLogoInNav').checked,
                    showWelcomeMessage: document.getElementById('showWelcomeMessage').checked,
                    enableAnimations: document.getElementById('enableAnimations').checked
                };
                
                // Get existing logo from database if it exists
                const existingSettings = await getCurrentBrandingSettings();
                if (existingSettings.logo) {
                    settings.logo = existingSettings.logo;
                }
                
                // Save to database
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Branding settings saved to database:', result);
                    
                    // Apply branding immediately
                    applyBrandingToNavigation();
                    
                    if (typeof window.showMessage === 'function') {
                        window.showMessage('Branding-Einstellungen gespeichert', 'success');
                    } else {
                        console.log('Branding-Einstellungen gespeichert');
                    }
                } else {
                    throw new Error('Failed to save branding settings');
                }
            } catch (error) {
                console.error('Error saving branding settings:', error);
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Fehler beim Speichern der Einstellungen', 'error');
                } else {
                    console.error('Fehler beim Speichern der Einstellungen');
                }
            }
        };
        
        // Reset all branding function - Define immediately
        window.resetAllBranding = function() {
            try {
                // Reset all form fields to default values
                const brandText = document.getElementById('brandText');
                if (brandText) brandText.value = 'Cadillac EV';
                
                const welcomeTitle = document.getElementById('welcomeTitle');
                if (welcomeTitle) welcomeTitle.value = 'Cadillac EV Assistant';
                
                const welcomeSubtitle = document.getElementById('welcomeSubtitle');
                if (welcomeSubtitle) welcomeSubtitle.value = 'Ihr persönlicher Assistent für Cadillac Elektrofahrzeuge';
                
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) pageTitle.value = 'Cadillac EV Assistant';
                
                const primaryColor = document.getElementById('primaryColor');
                if (primaryColor) primaryColor.value = '#2a2a3a';
                
                const secondaryColor = document.getElementById('secondaryColor');
                if (secondaryColor) secondaryColor.value = '#6b7280';
                
                // Reset checkboxes
                const showLogoInNav = document.getElementById('showLogoInNav');
                if (showLogoInNav) showLogoInNav.checked = true;
                
                const showWelcomeMessage = document.getElementById('showWelcomeMessage');
                if (showWelcomeMessage) showWelcomeMessage.checked = true;
                
                const enableAnimations = document.getElementById('enableAnimations');
                if (enableAnimations) enableAnimations.checked = true;
                
                // Reset logo
                resetLogoDirect();
                
                console.log('All branding settings reset to defaults');
            } catch (error) {
                console.error('Error resetting branding settings:', error);
            }
        };
        
        // Apply branding to navigation function - Define immediately
        window.applyBrandingToNavigation = async function() {
            try {
                console.log('🔄 Starting applyBrandingToNavigation...');
                const settings = await getCurrentBrandingSettings();
                console.log('📦 Loaded branding settings:', settings);
                
                // Apply brand text to navigation - look for the actual navigation structure
                const navBrand = document.querySelector('.nav-brand');
                if (navBrand && settings.brandText) {
                    // Find the text element within nav-brand
                    const textElement = navBrand.querySelector('span') || navBrand;
                    if (textElement) {
                        textElement.textContent = settings.brandText;
                        console.log('✅ Applied brand text to navigation:', settings.brandText);
                    }
                }
                
                // Apply logo to navigation - look for the actual logo element
                const navLogo = document.querySelector('.nav-brand-icon');
                console.log('🔍 Found nav logo element:', navLogo);
                console.log('🖼️ Settings logo exists:', !!settings.logo);
                
                if (navLogo && settings.logo) {
                    navLogo.innerHTML = `<img src="${settings.logo}" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">`;
                    navLogo.style.background = settings.logoBackgroundTransparent ? 'transparent' : '#2d2d2d';
                    console.log('✅ Applied custom logo to navigation');
                } else if (navLogo) {
                    navLogo.innerHTML = 'C';
                    navLogo.style.background = '#2d2d2d';
                    console.log('✅ Applied default logo to navigation');
                } else {
                    console.error('❌ Navigation logo element not found');
                }
                
                // Apply page title
                if (settings.pageTitle) {
                    document.title = settings.pageTitle;
                    console.log('✅ Applied page title:', settings.pageTitle);
                }
                
                // Apply colors to the interface
                if (settings.primaryColor) {
                    document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
                    console.log('✅ Applied primary color:', settings.primaryColor);
                }
                
                if (settings.secondaryColor) {
                    document.documentElement.style.setProperty('--secondary-color', settings.secondaryColor);
                    console.log('✅ Applied secondary color:', settings.secondaryColor);
                }
                
                if (settings.buttonColor) {
                    document.documentElement.style.setProperty('--button-color', settings.buttonColor);
                    // Apply button color to all buttons
                    const allButtons = document.querySelectorAll('button:not(.theme-toggle)');
                    allButtons.forEach(btn => {
                        if (!btn.classList.contains('theme-toggle')) {
                            btn.style.backgroundColor = settings.buttonColor;
                        }
                    });
                    console.log('✅ Applied button color:', settings.buttonColor);
                }
                
                console.log('✅ Branding applied to navigation successfully');
            } catch (error) {
                console.error('❌ Error applying branding to navigation:', error);
            }
        };
        
        // Test logo upload function
        window.testLogoUpload = async function() {
            console.log('🧪 Testing logo upload...');
            
            // Create a test logo using canvas
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            // Draw a test logo
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(0, 0, 64, 64);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('T', 32, 32);
            
            // Convert to data URL
            const dataURL = canvas.toDataURL('image/png');
            console.log('📷 Created test logo, dataURL length:', dataURL.length);
            
            // Update logo preview
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview) {
                logoPreview.innerHTML = `<img src="${dataURL}" alt="Test Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">`;
                console.log('✅ Test logo preview updated');
            }
            
            // Get current branding settings from database
            const settings = await getCurrentBrandingSettings();
            settings.logo = dataURL;
            console.log('💾 Test logo set in settings');
            
            // Save to database
            try {
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    console.log('✅ Test logo saved to database');
                    
                    // Apply branding immediately to navigation
                    console.log('🔄 Applying test logo to navigation...');
                    await applyBrandingToNavigation();
                    
                    if (typeof window.showMessage === 'function') {
                        window.showMessage('Test Logo erfolgreich hochgeladen!', 'success');
                    }
                } else {
                    throw new Error('Failed to save test logo to database');
                }
            } catch (error) {
                console.error('❌ Error saving test logo:', error);
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Fehler beim Speichern des Test-Logos', 'error');
                }
            }
        };

    </script>
    <script>
        let currentDeleteId = null;
        let currentDeleteType = null;

        // Tab switching
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.settings-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // Add active class to clicked tab
                    tab.classList.add('active');

                    // Show corresponding content
                    const targetTab = tab.getAttribute('data-tab');
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }

                    // Initialize specific tab functionality
                    if (targetTab === 'knowledge') {
                        setTimeout(() => {
                            initKnowledgeBase();
                        }, 100);
                    } else if (targetTab === 'technical') {
                        setTimeout(() => {
                            initTechnicalDatabase();
                        }, 100);
                    }
                });
            });
        }
        
        // Branding functions - now handled by database version above

        // Old functions removed - now using database version above

        // Make functions globally accessible
        window.resetLogoDirect = function() {
            try {
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    logoPreview.innerHTML = 'C';
                    logoPreview.style.backgroundImage = '';
                    console.log('Logo reset successfully');
                }
            } catch (error) {
                console.error('Error resetting logo:', error);
            }
        }
        
        // Old logo upload function removed - now using database version above
        
        function resetAllBranding() {
            try {
                // Reset all form fields to default values
                const brandText = document.getElementById('brandText');
                if (brandText) brandText.value = 'Cadillac EV';
                
                const welcomeTitle = document.getElementById('welcomeTitle');
                if (welcomeTitle) welcomeTitle.value = 'Cadillac EV Assistant';
                
                const welcomeSubtitle = document.getElementById('welcomeSubtitle');
                if (welcomeSubtitle) welcomeSubtitle.value = 'Ihr persönlicher Assistent für Cadillac Elektrofahrzeuge';
                
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) pageTitle.value = 'Cadillac EV Assistant';
                
                const primaryColor = document.getElementById('primaryColor');
                if (primaryColor) primaryColor.value = '#2a2a3a';
                
                const secondaryColor = document.getElementById('secondaryColor');
                if (secondaryColor) secondaryColor.value = '#6b7280';
                
                // Reset checkboxes
                const showLogoInNav = document.getElementById('showLogoInNav');
                if (showLogoInNav) showLogoInNav.checked = true;
                
                const showWelcomeMessage = document.getElementById('showWelcomeMessage');
                if (showWelcomeMessage) showWelcomeMessage.checked = true;
                
                const enableAnimations = document.getElementById('enableAnimations');
                if (enableAnimations) enableAnimations.checked = true;
                
                // Reset logo
                resetLogoDirect();
                
                console.log('All branding settings reset to defaults');
            } catch (error) {
                console.error('Error resetting branding settings:', error);
            }
        }
                
                // Reset logo in database
                const settings = await getCurrentBrandingSettings();
                settings.logo = null;
                
                // Save to database
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/branding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    // Apply branding to navigation immediately
                    applyBrandingToNavigation();
                    
                    if (typeof window.showMessage === 'function') {
                        window.showMessage('Logo zurückgesetzt!', 'success');
                    }
                } else {
                    throw new Error('Failed to reset logo in database');
                }
            } catch (error) {
                console.error('Error resetting logo:', error);
                if (typeof window.showMessage === 'function') {
                    window.showMessage('Fehler beim Zurücksetzen des Logos', 'error');
                }
            }
        }


        // Modal functions
        function showDeleteModal(docId, docName, docType) {
            currentDeleteId = docId;
            currentDeleteType = docType;
            document.getElementById('deleteDocName').textContent = docName;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentDeleteId = null;
            currentDeleteType = null;
        }

        function confirmDelete() {
            if (currentDeleteId && currentDeleteType) {
                if (currentDeleteType === 'knowledge') {
                    deleteKnowledgeDocument(currentDeleteId);
                } else if (currentDeleteType === 'technical') {
                    deleteTechnicalDocument(currentDeleteId);
                }
            }
            closeDeleteModal();
        }

        // Notification functions (moved to top of script section)

        // Refresh technical database function
        function refreshTechnicalDatabase() {
            console.log('🔄 Refreshing technical database...');
            if (typeof loadTechnicalDatabase === 'function') {
                loadTechnicalDatabase();
                } else {
                console.error('loadTechnicalDatabase function not found');
            }
        }

        // Old applyBrandingToNavigation function removed - now using database version above
        // Theme functions are now defined in the first script tag for early loading

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Settings page loaded');
            
            // Initialize theme FIRST
            if (typeof initializeTheme === 'function') {
                console.log('✅ Initializing theme...');
                initializeTheme();
            } else {
                console.log('⚠️ initializeTheme not found, applying default theme');
                document.documentElement.setAttribute('data-theme', 'light');
                document.body.setAttribute('data-theme', 'light');
            }
            
            // Setup theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', window.toggleTheme);
                console.log('✅ Theme toggle button event listener added');
            } else {
                console.error('❌ Theme toggle button not found');
            }
            
            // Setup language dropdown event listener
            const languageDropdown = document.getElementById('languageSetting');
            if (languageDropdown) {
                languageDropdown.addEventListener('change', function(e) {
                    if (typeof window.changeLanguage === 'function') {
                        window.changeLanguage(e.target.value);
                    }
                });
                console.log('✅ Language dropdown event listener added');
            } else {
                console.error('❌ Language dropdown not found');
            }
            
            // Apply branding to navigation
            applyBrandingToNavigation();
            
            // Setup tab navigation
            setupTabNavigation();
            
            // Load branding settings with proper timing
            console.log('🔄 DOMContentLoaded: About to call loadBrandingSettings()');
            // Call immediately after DOM is ready
            if (typeof window.loadBrandingSettings === 'function') {
                console.log('✅ loadBrandingSettings function exists, calling immediately...');
                window.loadBrandingSettings();
            } else {
                console.error('❌ loadBrandingSettings function not found');
            }
            
            // Additional call after a short delay to ensure all elements are ready
            setTimeout(() => {
                console.log('🔄 setTimeout: Calling loadBrandingSettings() after delay');
                if (typeof window.loadBrandingSettings === 'function') {
                    window.loadBrandingSettings();
                }
            }, 500);
            
            // Final call when page is fully loaded
            window.addEventListener('load', () => {
                console.log('🔄 Window load event: Calling loadBrandingSettings()');
                if (typeof window.loadBrandingSettings === 'function') {
                    window.loadBrandingSettings();
                }
            });
            
            // LOAD DATABASES IMMEDIATELY - MULTIPLE ATTEMPTS
            console.log('🔄 Loading databases on DOMContentLoaded...');
            
            // Attempt 1: Try immediately
            setTimeout(function() {
                console.log('🔄 Attempt 1: Executing database load...');
                
                if (typeof window.loadKnowledgeBase === 'function') {
                    console.log('✅ Calling loadKnowledgeBase...');
                    window.loadKnowledgeBase().catch(error => {
                        console.error('❌ Error loading knowledge base:', error);
                    });
                } else {
                    console.error('❌ loadKnowledgeBase not available');
                }
                
                if (typeof window.loadTechnicalDatabase === 'function') {
                    console.log('✅ Calling loadTechnicalDatabase...');
                    window.loadTechnicalDatabase().catch(error => {
                        console.error('❌ Error loading technical database:', error);
                    });
                } else {
                    console.error('❌ loadTechnicalDatabase not available');
                }
            }, 500);
            
            // Attempt 2: Try again after 2 seconds
            setTimeout(function() {
                console.log('🔄 Attempt 2: Retrying database load...');
                
                if (typeof window.loadKnowledgeBase === 'function') {
                    window.loadKnowledgeBase();
                }
                
                if (typeof window.loadTechnicalDatabase === 'function') {
                    window.loadTechnicalDatabase();
                }
            }, 2000);
            
            // Attempt 3: Try again after 4 seconds
            setTimeout(function() {
                console.log('🔄 Attempt 3: Final retry...');
                
                if (typeof window.loadKnowledgeBase === 'function') {
                    window.loadKnowledgeBase();
                }
                
                if (typeof window.loadTechnicalDatabase === 'function') {
                    window.loadTechnicalDatabase();
                }
            }, 4000);
            
            // Setup event listeners
            const logoUpload = document.getElementById('logoUpload');
            if (logoUpload) {
                logoUpload.addEventListener('change', function() {
                    handleLogoUploadDirect(this);
                });
            }
            
            const saveBtn = document.getElementById('saveBrandingBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveBrandingSettings);
            }
            
            // Initialize technical database function
            function initTechnicalDatabase() {
                console.log('🔧 Initializing technical database...');
                if (typeof window.loadTechnicalDatabase === 'function') {
                    console.log('✅ Loading technical database...');
                    window.loadTechnicalDatabase();
                } else {
                    console.error('❌ loadTechnicalDatabase function not found');
                }
            }
            
            // Initialize knowledge base function
            function initKnowledgeBase() {
                console.log('🔧 Initializing knowledge base...');
                if (typeof window.loadKnowledgeBase === 'function') {
                    console.log('✅ Loading knowledge base...');
                    window.loadKnowledgeBase();
                } else {
                    console.error('❌ loadKnowledgeBase function not found');
                }
            }
            
            // Initialize enhanced databases function
            function initEnhancedDatabases() {
                console.log('🔧 Initializing enhanced databases...');
                // This function will be called by the existing code
            }
            
        // Initialize autocomplete function
        function initAutocomplete() {
            console.log('🔧 Initializing autocomplete...');
            // This function will be called by the existing code
        }
        
        // Initialize enhanced databases functionality
            setTimeout(function() {
                console.log('🔄 Starting database initialization...');
                
                // Initialize enhanced database features
                if (typeof initEnhancedDatabases === 'function') {
                    console.log('✅ Initializing enhanced database features...');
                    try {
                        initEnhancedDatabases();
                        console.log('✅ Enhanced database features initialized');
                    } catch (error) {
                        console.error('❌ Error initializing enhanced database features:', error);
                    }
                } else {
                    console.error('❌ initEnhancedDatabases function not found');
                }
                
                // Initialize autocomplete
                if (typeof initAutocomplete === 'function') {
                    console.log('✅ Initializing autocomplete...');
                    try {
                        initAutocomplete();
                        console.log('✅ Autocomplete initialized');
                    } catch (error) {
                        console.error('❌ Error initializing autocomplete:', error);
                    }
                } else {
                    console.error('❌ initAutocomplete function not found');
                }
                
                // Load databases with additional delay to ensure DOM is ready
                setTimeout(function() {
                    console.log('🔄 Loading databases...');
                    
                    // Load knowledge base
                    if (typeof loadKnowledgeBase === 'function') {
                        console.log('✅ Loading knowledge base on page load...');
                        try {
                            loadKnowledgeBase().then(() => {
                                console.log('✅ Knowledge base loaded successfully');
                            }).catch(error => {
                                console.error('❌ Error loading knowledge base:', error);
                            });
                        } catch (error) {
                            console.error('❌ Error calling loadKnowledgeBase:', error);
                        }
                    } else {
                        console.error('❌ loadKnowledgeBase function not found');
                    }
                    
                    // Load technical database
                    if (typeof loadTechnicalDatabase === 'function') {
                        console.log('✅ Loading technical database on page load...');
                        try {
                            loadTechnicalDatabase().then(() => {
                                console.log('✅ Technical database loaded successfully');
                            }).catch(error => {
                                console.error('❌ Error loading technical database:', error);
                            });
                        } catch (error) {
                            console.error('❌ Error calling loadTechnicalDatabase:', error);
                        }
                    } else {
                        console.error('❌ loadTechnicalDatabase function not found');
                    }
                }, 1000); // Additional 1 second delay for database loading
            }, 500);
        });
        
        // Tab switching function - Make globally accessible
        window.switchSettingsTab = function(tabName) {
            console.log('🔄 Switching to tab:', tabName);
            
            try {
                // Remove active class from all tabs
                const allTabs = document.querySelectorAll('.settings-tab');
                allTabs.forEach(tab => tab.classList.remove('active'));
                
                // Hide all tab content
                const allContent = document.querySelectorAll('.tab-content');
                allContent.forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                
                // Activate selected tab
                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }
                
                // Show selected content
                const selectedContent = document.getElementById(tabName);
                if (selectedContent) {
                    selectedContent.classList.add('active');
                    selectedContent.style.display = 'block';
                }
                
                // Initialize tab-specific functionality
                if (tabName === 'knowledge') {
                    console.log('📚 Initializing knowledge base...');
                    if (typeof window.loadKnowledgeBase === 'function') {
                        window.loadKnowledgeBase();
                    } else {
                        console.error('❌ loadKnowledgeBase function not found');
                    }
                } else if (tabName === 'technical') {
                    console.log('🔧 Initializing technical database...');
                    if (typeof window.loadTechnicalDatabase === 'function') {
                        window.loadTechnicalDatabase();
                    } else {
                        console.error('❌ loadTechnicalDatabase function not found');
                    }
                }
                
                console.log('✅ Tab switched to:', tabName);
            } catch (error) {
                console.error('❌ Error switching tab:', error);
            }
        };
        
        // Navigation function
        function switchPage(page) {
            console.log('Switching to page:', page);
            switch(page) {
                case 'dashboard':
                    window.location.href = 'dashboard.html';
                    break;
                case 'chat':
                    window.location.href = 'chat.html';
                    break;
                case 'troubleshooting':
                    window.location.href = 'troubleshooting.html';
                    break;
                case 'settings':
                    window.location.href = 'settings.html';
                    break;
                default:
                    console.log('Unknown page:', page);
            }
        }
        
        // Make switchPage globally accessible
        window.switchPage = switchPage;
        
        // Call loadBrandingSettings immediately when script loads
        console.log('🔄 Script loaded: Calling loadBrandingSettings() immediately');
        if (typeof window.loadBrandingSettings === 'function') {
            window.loadBrandingSettings();
        }
        
        // Force call after page is fully loaded
        window.addEventListener('load', function() {
            console.log('🔄 Window load event: Force calling loadBrandingSettings()');
            setTimeout(function() {
                if (typeof window.loadBrandingSettings === 'function') {
                    window.loadBrandingSettings();
                }
            }, 1000);
        });
        
        // Additional immediate call with longer delay
        setTimeout(function() {
            console.log('🔄 Additional timeout: Calling loadBrandingSettings()');
            if (typeof window.loadBrandingSettings === 'function') {
                window.loadBrandingSettings();
            }
        }, 2000);
        
        // Final call with even longer delay
        setTimeout(function() {
            console.log('🔄 Final timeout: Calling loadBrandingSettings()');
            if (typeof window.loadBrandingSettings === 'function') {
                window.loadBrandingSettings();
            }
        }, 5000);
        
        // Call when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('🔄 Page visible: Calling loadBrandingSettings()');
                if (typeof window.loadBrandingSettings === 'function') {
                    window.loadBrandingSettings();
                }
            }
        });
        
</body>
</html>>