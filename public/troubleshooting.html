<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadillac EV Assistant - Troubleshooting</title>
    <link rel="stylesheet" href="styles.css?v=20250126-003">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/i18n.js?v=1730000020"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <!-- Advanced Troubleshooting Integration -->
        <!-- <script src="../integrate-advanced-troubleshooting.js"></script> -->
        <!-- File not accessible from public folder - functionality integrated in app.js -->
        <!-- Completely Automatic Advanced API -->
        <script src="auto-start-advanced-api.js"></script>
        <!-- Automatic Startup Manager -->
        <script src="startup-api.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-brand-icon" id="navLogo">C</div>
            <span id="navBrandText">Cadillac EV</span>
        </div>
        <div class="nav-menu">
            <a class="nav-item" href="dashboard.html" data-page="dashboard" data-i18n="nav.dashboard">Dashboard</a>
            <a class="nav-item" href="chat.html" data-page="chat" data-i18n="nav.chat">Chat</a>
            <a class="nav-item active" href="troubleshooting.html" data-page="troubleshooting" data-i18n="nav.troubleshooting">Troubleshooting</a>
            <a class="nav-item" href="settings.html" data-page="settings" data-i18n="nav.settings">Einstellungen</a>
            <select class="language-selector" id="languageSelector" onchange="if(window.i18n) window.i18n.changeLanguage(this.value)" title="Sprache wählen">
                <option value="de">DE</option>
                <option value="en">EN</option>
                <option value="fr">FR</option>
            </select>
            <button class="theme-toggle" id="themeToggle" title="Theme wechseln">
                <svg class="theme-icon sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <svg class="theme-icon moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Troubleshooting Page -->
    <div class="page active" id="troubleshootingPage">
        <div class="troubleshooting-container">
            <h1 style="font-size: 32px; font-weight: 200; margin: 0 0 8px; color: #2a2a2a;" data-i18n="troubleshooting.title">Troubleshooting</h1>
            <p style="color: #6b7280; font-size: 16px; margin: 0 0 32px;" data-i18n="troubleshooting.subtitle">Hilfe bei Problemen mit Ihrem Cadillac EV</p>
            
            <!-- Troubleshooting Tools -->
            <div style="margin-bottom: 3rem;">
                <!-- Upload Image Section -->
                <div class="settings-section">
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: #2d2d2d;" data-i18n="troubleshooting.intelligentDiagnosis">Intelligente Problemdiagnose</h2>
                    <p style="color: #6b7280; font-size: 15px; margin-bottom: 24px; line-height: 1.6;" data-i18n="troubleshooting.diagnosisDescription">Laden Sie ein Bild des Problems hoch und erhalten Sie eine sofortige AI-gestützte Diagnose mit Lösungsvorschlägen aus unseren Fahrzeughandbüchern.</p>
                    
                    <div class="upload-area" id="uploadArea" style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f9fafb;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 64px; height: 64px; margin: 0 auto 16px; color: #9ca3af;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <div class="upload-text" style="font-size: 17px; font-weight: 600; color: #374151; margin-bottom: 8px;" data-i18n="troubleshooting.uploadImage">Bild hochladen</div>
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 12px;" data-i18n="troubleshooting.clickOrDrag">Klicken zum Auswählen oder Drag & Drop</div>
                        <div class="upload-subtext" style="font-size: 13px; color: #9ca3af;" data-i18n="troubleshooting.fileFormats">JPG, PNG, GIF - Max. 10MB</div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="image-preview" id="imagePreview" style="display: none; margin-top: 24px; padding: 16px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <div style="position: relative; display: inline-block;">
                            <img id="previewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block;">
                            <button id="removeImage" style="position: absolute; top: 8px; right: 8px; padding: 8px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: all 0.2s;" onmouseover="this.style.background='rgba(220, 38, 38, 1)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.9)'">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="issue-description" style="margin-top: 24px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: #374151;" data-i18n="troubleshooting.describeProblem">Problem beschreiben (optional)</label>
                        <textarea id="problemDescription" data-i18n-placeholder="troubleshooting.problemPlaceholder" placeholder="Beschreiben Sie das Problem genau oder lassen Sie das Feld leer für reine Bildanalyse..." style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; font-family: inherit; font-size: 15px; font-weight: 500; color: #1f2937; background: #ffffff; resize: vertical; min-height: 120px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"></textarea>
                    </div>
                    
                    <div class="vehicle-model" style="margin-top: 20px; text-align: right;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: #374151;" data-i18n="troubleshooting.vehicleModel">Fahrzeugmodell</label>
                        <select id="vehicleModel" style="width: auto; max-width: 300px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; font-size: 15px; font-weight: 500; background: #ffffff; color: #1f2937; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                            <option value="" data-i18n="troubleshooting.selectModel">Modell auswählen...</option>
                            <option value="Cadillac LYRIQ">Cadillac LYRIQ</option>
                            <option value="Cadillac VISTIQ">Cadillac VISTIQ</option>
                            <option value="Cadillac OPTIQ">Cadillac OPTIQ</option>
                        </select>
                    </div>
                    
                    <div style="text-align: right;">
                        <button id="analyzeProblem" class="btn-primary" style="margin-top: 24px; width: auto; display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 15px; font-weight: 600;" onclick="analyzeProblem()">
                            <span id="analyzeText" data-i18n="troubleshooting.analyzeProblem">Problem analysieren</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Results Section -->
            <div id="analysisResults" style="margin-top: 2rem;">
                <!-- Results will be displayed here -->
            </div>

            <!-- Technical Database Section -->
            <div class="branding-section" style="margin-top: 3rem;">
                <h2 style="font-weight: 500; color: #2d2d2d; margin-bottom: 8px;" data-i18n="settings.technicalDb.title">Technische Datenbank</h2>
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 24px;" data-i18n="settings.technicalDb.subtitle">Verwalten Sie technische Dokumente</p>
                
                <!-- Statistics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="techDocCount">0</div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <div class="stat-label" data-i18n="settings.technicalDb.documents">Dokumente</div>
                            <div class="stat-description">Technische Datenbank</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="techTotalSize">0 MB</div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <div class="stat-label" data-i18n="settings.technicalDb.totalSize">Gesamtgröße</div>
                            <div class="stat-description" data-i18n="settings.technicalDb.allFiles">Alle Dateien</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="techLastUpdate">-</div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <div class="stat-label" data-i18n="settings.technicalDb.lastUpdate">Letzte Aktualisierung</div>
                            <div class="stat-description">Technische Datenbank</div>
                        </div>
                    </div>
                </div>
                
                <!-- Search & Controls -->
                <div class="database-controls" style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <div style="position: relative; flex: 1;">
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="techSearch" data-i18n-placeholder="settings.technicalDb.searchPlaceholder" placeholder="Technische Dokumente durchsuchen..." 
                            style="width: 100%; padding: 12px 14px 12px 44px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                            onfocus="this.style.borderColor='var(--primary-color)'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
                            onkeyup="window.searchTechnicalDatabase()">
                    </div>
                    <select id="techFilter" style="padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;" onchange="window.filterTechnicalDatabase()">
                        <option value="" data-i18n="settings.technicalDb.allCategories">Alle Kategorien</option>
                    </select>
                    <select id="techSort" style="padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;" onchange="window.sortTechnicalDatabase()">
                        <option value="newest" data-i18n="settings.technicalDb.sortNewest">Neueste zuerst</option>
                        <option value="oldest" data-i18n="settings.technicalDb.sortOldest">Älteste zuerst</option>
                        <option value="name-asc" data-i18n="settings.technicalDb.nameAZ">Name (A-Z)</option>
                        <option value="name-desc" data-i18n="settings.technicalDb.nameZA">Name (Z-A)</option>
                        <option value="size-asc" data-i18n="settings.technicalDb.sizeAsc">Größe (aufsteigend)</option>
                        <option value="size-desc" data-i18n="settings.technicalDb.sizeDesc">Größe (absteigend)</option>
                    </select>
                </div>

                <!-- Loading State -->
                <div id="techLoadingState" style="display: none; text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 16px; color: #6b7280;">Lädt technische Dokumente...</p>
                </div>

                <!-- Documents List -->
                <div id="techList" style="border: 1px solid #e5e7eb; border-radius: 12px; background: white; min-height: 200px; padding: 0 20px;"></div>

                <!-- Pagination (dynamically generated by app.js) -->
                <div id="techPagination" style="display: none; width: 100%;"></div>
            </div>
            
            <style>
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            </style>
            
            <script>
            // INLINE LOADER FOR TECHNICAL DATABASE
            (function() {
                console.log('📚 INLINE: Starting Technical Database Loader...');
                
                const loadingState = document.getElementById('techLoadingState');
                const techList = document.getElementById('techList');
                if (loadingState && techList) {
                    loadingState.style.display = 'block';
                    techList.innerHTML = '';
                }
                
                const formatSize = (bytes) => {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                };
                
                const formatDate = (date) => {
                    if (!date) return '-';
                    let timestamp;
                    if (typeof date === 'object') {
                        if (date._seconds) timestamp = date._seconds * 1000;
                        else if (date.seconds) timestamp = date.seconds * 1000;
                        else if (date.toDate) timestamp = date.toDate().getTime();
                        else timestamp = new Date(date).getTime();
                    } else {
                        timestamp = new Date(date).getTime();
                    }
                    const d = new Date(timestamp);
                    return isNaN(d.getTime()) ? '-' : d.toLocaleDateString('de-DE');
                };
                
                fetch('https://us-central1-cis-de.cloudfunctions.net/technicalDatabase?t=' + Date.now())
                    .then(res => res.json())
                    .then(data => {
                        const docs = data.documents || [];
                        console.log('✅ INLINE: Loaded', docs.length, 'technical documents');
                        
                        // Update statistics
                        document.getElementById('techDocCount').textContent = docs.length;
                        const size = docs.reduce((sum, doc) => sum + (Number(doc.size) || Number(doc.fileSize) || Number(doc.bytes) || 0), 0);
                        document.getElementById('techTotalSize').textContent = formatSize(size);
                        
                        if (docs.length > 0) {
                            const timestamps = docs.map(d => {
                                const ts = d.uploadedAt;
                                if (typeof ts === 'number') return ts;
                                if (ts && ts.seconds) return ts.seconds * 1000;
                                if (ts && ts._seconds) return ts._seconds * 1000;
                                return 0;
                            }).filter(t => t > 0);
                            if (timestamps.length > 0) {
                                const lastUpdated = Math.max(...timestamps);
                                document.getElementById('techLastUpdate').textContent = formatDate(new Date(lastUpdated));
                            }
                        }
                        
                        window.technicalDatabase = docs;
                        if (loadingState) loadingState.style.display = 'none';
                        
                        if (techList) {
                            if (docs.length === 0) {
                                techList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Keine Dokumente gefunden</div>';
                            } else {
                                // Pagination logic (10 items per page)
                                if (!window.techPaginationState) {
                                    window.techPaginationState = { currentPage: 1, itemsPerPage: 10 };
                                }
                                const state = window.techPaginationState;
                                const startIdx = (state.currentPage - 1) * state.itemsPerPage;
                                const endIdx = startIdx + state.itemsPerPage;
                                const pageDocs = docs.slice(startIdx, endIdx);
                                
                                console.log('📄 Rendering with pagination:', {
                                    total: docs.length,
                                    showing: pageDocs.length,
                                    page: state.currentPage,
                                    start: startIdx,
                                    end: endIdx
                                });
                                
                                // Store full docs list
                                window.techAllDocuments = docs;
                                
                                // Now try to use displayTechnicalDatabase if available
                                if (typeof displayTechnicalDatabase === 'function') {
                                    console.log('✅ Using displayTechnicalDatabase');
                                    displayTechnicalDatabase(docs);
                                } else {
                                    console.log('⚠️ Using inline rendering');
                                    let html = '';
                                    
                                    const formatSize = (bytes) => {
                                        if (!bytes) return '0 B';
                                        const k = 1024;
                                        const sizes = ['B', 'KB', 'MB', 'GB'];
                                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                                        return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
                                    };
                                    
                                    const formatDate = (date) => {
                                        if (!date) return '-';
                                        let timestamp;
                                        if (typeof date === 'object') {
                                            if (date._seconds) timestamp = date._seconds * 1000;
                                            else if (date.seconds) timestamp = date.seconds * 1000;
                                            else if (date.toDate) timestamp = date.toDate().getTime();
                                            else timestamp = new Date(date).getTime();
                                        } else {
                                            timestamp = new Date(date).getTime();
                                        }
                                        const d = new Date(timestamp);
                                        if (isNaN(d.getTime())) return '-';
                                        return d.toLocaleDateString('de-DE');
                                    };
                                    
                                    const getFileType = (filename) => {
                                        const ext = (filename || '').split('.').pop().toUpperCase();
                                        return ext || 'UNKNOWN';
                                    };
                                    
                                    pageDocs.forEach((doc, idx) => {
                                        // Use fileType from API if available, otherwise extract from filename
                                        const fileType = doc.fileType ? doc.fileType.toUpperCase() : getFileType(doc.name || doc.filename);
                                        html += '<div class="kb-item" style="border-bottom: 1px solid #e5e7eb; padding: 20px 0; background: transparent;">';
                                        html += '<div class="kb-item-header" style="display: flex; align-items: center; justify-content: space-between;">';
                                        html += '<div style="display: flex; align-items: center; flex: 1; min-width: 200px;">';
                                        html += '<input type="checkbox" class="kb-checkbox" style="margin-right: 16px; width: 18px; height: 18px; cursor: pointer;">';
                                        html += '<div class="kb-item-title" style="font-weight: 400; color: #2d2d2d; font-size: 15px;">' + (doc.name || doc.filename || 'Unbekannt') + '</div>';
                                        html += '</div>';
                                        html += '<div style="display: flex; gap: 12px; align-items: center;">';
                                        html += '<div style="color: #6b7280; font-size: 13px; min-width: 80px; text-align: right;">' + formatDate(doc.uploadedAt) + '</div>';
                                        html += '<div class="kb-tools" style="display: flex; gap: 8px;">';
                                        html += '<button onclick="window.viewTechDoc(\'' + doc.id + '\')" style="width: 36px; height: 36px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#2563eb\'" onmouseout="this.style.background=\'#3b82f6\'" title="Vorschau">';
                                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14L20.5,19.79L19.79,20.5L14,14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>';
                                        html += '</button>';
                                        html += '<button onclick="window.downloadTechDoc(\'' + doc.id + '\')" style="width: 36px; height: 36px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#059669\'" onmouseout="this.style.background=\'#10b981\'" title="Download">';
                                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.04M14,13V17H10V13H7L12,8L17,13H14Z"/></svg>';
                                        html += '</button>';
                                        html += '<button onclick="window.deleteTechDoc(\'' + doc.id + '\', \'' + (doc.name || doc.filename || 'Unbekannt').replace(/\'/g, '\\\'') + '\')" style="width: 36px; height: 36px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#dc2626\'" onmouseout="this.style.background=\'#ef4444\'" title="Löschen">';
                                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9V17H10V9H8M14,9V17H16V9H14Z"/></svg>';
                                        html += '</button>';
                                        html += '</div>';
                                        html += '</div>';
                                        html += '</div>';
                                        html += '<div class="kb-item-meta" style="display: flex; gap: 10px; padding: 12px 0 0 34px;">';
                                        html += '<span style="display: inline-flex; align-items: center; padding: 5px 12px; background: #e0e7ff; color: #4338ca; border-radius: 6px; font-size: 12px; font-weight: 500; letter-spacing: 0.3px;">';
                                        html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20"/></svg>';
                                        html += fileType;
                                        html += '</span>';
                                        html += '<span style="display: inline-flex; align-items: center; padding: 5px 12px; background: #f3f4f6; color: #374151; border-radius: 6px; font-size: 12px; font-weight: 500;">';
                                        html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;"><path d="M12,3C7.58,3 4,4.79 4,7C4,9.21 7.58,11 12,11C16.42,11 20,9.21 20,7C20,4.79 16.42,3 12,3M4,9V12C4,14.21 7.58,16 12,16C16.42,16 20,14.21 20,12V9C20,11.21 16.42,13 12,13C7.58,13 4,11.21 4,9M4,14V17C4,19.21 7.58,21 12,21C16.42,21 20,19.21 20,17V14C20,16.21 16.42,18 12,18C7.58,18 4,16.21 4,14Z"/></svg>';
                                        html += formatSize(Number(doc.size) || Number(doc.fileSize) || Number(doc.bytes) || 0);
                                        html += '</span>';
                                        if (doc.category) {
                                            html += '<span style="display: inline-flex; align-items: center; padding: 5px 12px; background: #fef3c7; color: #92400e; border-radius: 6px; font-size: 12px; font-weight: 500;">';
                                            html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 5px;"><path d="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.77,14.05 22,13.55 22,13C22,12.45 21.77,11.95 21.41,11.58Z"/></svg>';
                                            html += doc.category;
                                            html += '</span>';
                                        }
                                        html += '</div>';
                                        html += '</div>';
                                    });
                                    techList.innerHTML = html;
                                    
                                    // Render pagination
                                    const paginationContainer = document.getElementById('techPagination');
                                    if (paginationContainer && docs.length > 10) {
                                        const totalPages = Math.ceil(docs.length / 10);
                                        paginationContainer.style.display = 'flex';
                                        paginationContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 0; width: 100%;"><button onclick="window.goToTechnicalPage(' + (state.currentPage - 1) + ')" ' + (state.currentPage === 1 ? 'disabled' : '') + ' style="padding: 10px 16px; background: ' + (state.currentPage === 1 ? '#f3f4f6' : '#ffffff') + '; color: ' + (state.currentPage === 1 ? '#9ca3af' : '#374151') + '; border: 1px solid #e5e7eb; border-radius: 8px; cursor: ' + (state.currentPage === 1 ? 'not-allowed' : 'pointer') + '; font-weight: 500; font-size: 14px; transition: all 0.2s;">Zurück</button><span style="padding: 10px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-weight: 500; font-size: 14px; color: #374151;">Seite ' + state.currentPage + ' von ' + totalPages + '</span><button onclick="window.goToTechnicalPage(' + (state.currentPage + 1) + ')" ' + (state.currentPage === totalPages ? 'disabled' : '') + ' style="padding: 10px 16px; background: ' + (state.currentPage === totalPages ? '#f3f4f6' : '#ffffff') + '; color: ' + (state.currentPage === totalPages ? '#9ca3af' : '#374151') + '; border: 1px solid #e5e7eb; border-radius: 8px; cursor: ' + (state.currentPage === totalPages ? 'not-allowed' : 'pointer') + '; font-weight: 500; font-size: 14px; transition: all 0.2s;">Weiter</button></div>';
                                    }
                                }
                            }
                        }
                        console.log('✅ INLINE: Technical Database loading complete!');
                    })
                    .catch(err => {
                        console.error('❌ INLINE ERROR:', err);
                        if (loadingState) loadingState.style.display = 'none';
                        if (techList) {
                            techList.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc2626;">Fehler: ' + err.message + '</div>';
                        }
                    });
            })();
            </script>
            
            <script>
            // Pagination navigation function
            window.goToTechnicalPage = function(page) {
                if (!window.techPaginationState || !window.techAllDocuments) return;
                
                const state = window.techPaginationState;
                const totalPages = Math.ceil(window.techAllDocuments.length / state.itemsPerPage);
                
                if (page < 1 || page > totalPages) return;
                
                state.currentPage = page;
                
                const startIdx = (state.currentPage - 1) * state.itemsPerPage;
                const endIdx = startIdx + state.itemsPerPage;
                const pageDocs = window.techAllDocuments.slice(startIdx, endIdx);
                
                const techList = document.getElementById('techList');
                if (techList) {
                    const formatSize = (bytes) => {
                        if (!bytes) return '0 B';
                        const k = 1024;
                        const sizes = ['B', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
                    };
                    
                    const formatDate = (date) => {
                        if (!date) return '-';
                        let timestamp;
                        if (typeof date === 'object') {
                            if (date._seconds) timestamp = date._seconds * 1000;
                            else if (date.seconds) timestamp = date.seconds * 1000;
                            else if (date.toDate) timestamp = date.toDate().getTime();
                            else timestamp = new Date(date).getTime();
                        } else {
                            timestamp = new Date(date).getTime();
                        }
                        const d = new Date(timestamp);
                        if (isNaN(d.getTime())) return '-';
                        return d.toLocaleDateString('de-DE');
                    };
                    
                    const getFileType = (filename) => {
                        const ext = (filename || '').split('.').pop().toUpperCase();
                        return ext || 'UNKNOWN';
                    };
                    
                    let html = '';
                    pageDocs.forEach((doc, idx) => {
                        // Use fileType from API if available, otherwise extract from filename
                        const fileType = doc.fileType ? doc.fileType.toUpperCase() : getFileType(doc.name || doc.filename);
                        html += '<div class="kb-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0; margin-bottom: 12px; background: white; overflow: hidden;">';
                        html += '<div class="kb-item-header" style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #f3f4f6;">';
                        html += '<div style="display: flex; align-items: center; flex: 1; min-width: 200px;">';
                        html += '<input type="checkbox" class="kb-checkbox" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">';
                        html += '<div class="kb-item-title" style="font-weight: 600; color: #111827; font-size: 15px;">' + (doc.name || doc.filename || 'Unbekannt') + '</div>';
                        html += '</div>';
                        html += '<div style="display: flex; gap: 10px; align-items: center;">';
                        html += '<div style="color: #6b7280; font-size: 13px;">' + formatDate(doc.uploadedAt) + '</div>';
                        html += '<div class="kb-tools" style="display: flex; gap: 6px;">';
                        html += '<button onclick="window.viewTechDoc(\'' + doc.id + '\')" style="width: 32px; height: 32px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#2563eb\'" onmouseout="this.style.background=\'#3b82f6\'" title="Vorschau">';
                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14L20.5,19.79L19.79,20.5L14,14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>';
                        html += '</button>';
                        html += '<button onclick="window.downloadTechDoc(\'' + doc.id + '\')" style="width: 32px; height: 32px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#059669\'" onmouseout="this.style.background=\'#10b981\'" title="Download">';
                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.04M14,13V17H10V13H7L12,8L17,13H14Z"/></svg>';
                        html += '</button>';
                        html += '<button onclick="window.deleteTechDoc(\'' + doc.id + '\', \'' + (doc.name || doc.filename || 'Unbekannt').replace(/\'/g, '\\\'') + '\')" style="width: 32px; height: 32px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'#dc2626\'" onmouseout="this.style.background=\'#ef4444\'" title="Löschen">';
                        html += '<svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9V17H10V9H8M14,9V17H16V9H14Z"/></svg>';
                        html += '</button>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                        html += '<div class="kb-item-meta" style="display: flex; gap: 8px; padding: 12px 16px; background: #f9fafb;">';
                        html += '<span style="display: inline-flex; align-items: center; padding: 4px 10px; background: #e0e7ff; color: #3730a3; border-radius: 4px; font-size: 12px; font-weight: 600;">';
                        html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20"/></svg>';
                        html += fileType;
                        html += '</span>';
                        html += '<span style="display: inline-flex; align-items: center; padding: 4px 10px; background: #f3f4f6; color: #374151; border-radius: 4px; font-size: 12px; font-weight: 500;">';
                        html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;"><path d="M12,3C7.58,3 4,4.79 4,7C4,9.21 7.58,11 12,11C16.42,11 20,9.21 20,7C20,4.79 16.42,3 12,3M4,9V12C4,14.21 7.58,16 12,16C16.42,16 20,14.21 20,12V9C20,11.21 16.42,13 12,13C7.58,13 4,11.21 4,9M4,14V17C4,19.21 7.58,21 12,21C16.42,21 20,19.21 20,17V14C20,16.21 16.42,18 12,18C7.58,18 4,16.21 4,14Z"/></svg>';
                        html += formatSize(Number(doc.size) || Number(doc.fileSize) || Number(doc.bytes) || 0);
                        html += '</span>';
                        if (doc.category) {
                            html += '<span style="display: inline-flex; align-items: center; padding: 4px 10px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 12px; font-weight: 500;">';
                            html += '<svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 4px;"><path d="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.77,14.05 22,13.55 22,13C22,12.45 21.77,11.95 21.41,11.58Z"/></svg>';
                            html += doc.category;
                            html += '</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    techList.innerHTML = html;
                }
                
                // Update pagination controls
                const paginationContainer = document.getElementById('techPagination');
                if (paginationContainer && window.techAllDocuments.length > 10) {
                    paginationContainer.style.display = 'flex';
                    paginationContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px 0; width: 100%;"><button onclick="window.goToTechnicalPage(' + (state.currentPage - 1) + ')" ' + (state.currentPage === 1 ? 'disabled' : '') + ' style="padding: 10px 16px; background: ' + (state.currentPage === 1 ? '#f3f4f6' : '#ffffff') + '; color: ' + (state.currentPage === 1 ? '#9ca3af' : '#374151') + '; border: 1px solid #e5e7eb; border-radius: 8px; cursor: ' + (state.currentPage === 1 ? 'not-allowed' : 'pointer') + '; font-weight: 500; font-size: 14px; transition: all 0.2s;">Zurück</button><span style="padding: 10px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-weight: 500; font-size: 14px; color: #374151;">Seite ' + state.currentPage + ' von ' + totalPages + '</span><button onclick="window.goToTechnicalPage(' + (state.currentPage + 1) + ')" ' + (state.currentPage === totalPages ? 'disabled' : '') + ' style="padding: 10px 16px; background: ' + (state.currentPage === totalPages ? '#f3f4f6' : '#ffffff') + '; color: ' + (state.currentPage === totalPages ? '#9ca3af' : '#374151') + '; border: 1px solid #e5e7eb; border-radius: 8px; cursor: ' + (state.currentPage === totalPages ? 'not-allowed' : 'pointer') + '; font-weight: 500; font-size: 14px; transition: all 0.2s;">Weiter</button></div>';
                }
            };
            
            // View document function
            window.viewTechDoc = function(docId) {
                const url = `https://us-central1-cis-de.cloudfunctions.net/viewDocument?docId=${docId}&type=technical`;
                window.open(url, '_blank');
            };
            
            // Download document function
            window.downloadTechDoc = function(docId) {
                const doc = window.techAllDocuments.find(d => d.id === docId);
                if (!doc) return;
                
                const url = `https://us-central1-cis-de.cloudfunctions.net/downloadDocument?id=${docId}&type=technical`;
                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = doc.filename || doc.name || 'document';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(downloadUrl);
                        document.body.removeChild(a);
                    })
                    .catch(error => console.error('Download error:', error));
            };
            
            // Custom confirmation modal
            window.showConfirmDialog = function(message, onConfirm, onCancel) {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background: white; border-radius: 12px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);';
                
                modal.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <div style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 8px;">Bestätigung</div>
                        <div style="color: #6b7280; font-size: 15px;">${message}</div>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="cancelBtn" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Abbrechen</button>
                        <button id="confirmBtn" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">Löschen</button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                const closeModal = () => {
                    document.body.removeChild(overlay);
                };
                
                document.getElementById('cancelBtn').addEventListener('click', () => {
                    closeModal();
                    if (onCancel) onCancel();
                });
                
                document.getElementById('confirmBtn').addEventListener('click', () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                        if (onCancel) onCancel();
                    }
                });
            };
            
            // Delete document function
            window.deleteTechDoc = function(docId, docName) {
                window.showConfirmDialog(
                    `Möchten Sie "${docName}" wirklich löschen?`,
                    () => {
                        fetch('https://us-central1-cis-de.cloudfunctions.net/deleteDocument', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: docId, type: 'technical' })
                        })
                        .then(response => {
                            if (response.ok) {
                                // Remove from local array
                                window.techAllDocuments = window.techAllDocuments.filter(d => d.id !== docId);
                                window.technicalDatabase = window.technicalDatabase.filter(d => d.id !== docId);
                                
                                // Update stats
                                document.getElementById('techDocCount').textContent = window.techAllDocuments.length;
                                const size = window.techAllDocuments.reduce((sum, doc) => sum + (doc.size || 0), 0);
                                document.getElementById('techTotalSize').textContent = (size / (1024 * 1024)).toFixed(2) + ' MB';
                                
                                // Refresh display
                                const state = window.techPaginationState;
                                const totalPages = Math.ceil(window.techAllDocuments.length / state.itemsPerPage);
                                if (state.currentPage > totalPages && totalPages > 0) {
                                    state.currentPage = totalPages;
                                }
                                window.goToTechnicalPage(state.currentPage);
                                
                                // Show success notification
                                window.showNotification('Dokument erfolgreich gelöscht.', 'success');
                            } else {
                                window.showNotification('Fehler beim Löschen des Dokuments.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Delete error:', error);
                            window.showNotification('Fehler beim Löschen des Dokuments.', 'error');
                        });
                    }
                );
            };
            
            // Show notification
            window.showNotification = function(message, type = 'success') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${type === 'error' ? '#ef4444' : '#10b981'};
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    z-index: 10001;
                    font-size: 14px;
                    font-weight: 500;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            };
            </script>
        </div>
    </div>

    <script>
        // Define global storage for documents
        window.technicalDatabase = [];
        
        // Simple loader that runs immediately when app.js is ready
        window.loadTechDB = function() {
            console.log('🚀 loadTechDB called - loading technical database...');
            
            fetch('https://us-central1-cis-de.cloudfunctions.net/technicalDatabase')
                .then(res => res.json())
                .then(data => {
                    console.log('✅ Loaded', data.documents.length, 'documents');
                    window.technicalDatabase = data.documents;
                    
                    // Now call display function if it exists
                    if (typeof displayTechnicalDatabase === 'function') {
                        console.log('📋 Calling displayTechnicalDatabase...');
                        displayTechnicalDatabase(window.technicalDatabase);
                    } else {
                        console.log('⏳ displayTechnicalDatabase not ready yet...');
                        // Retry after 500ms
                        setTimeout(() => {
                            if (typeof displayTechnicalDatabase === 'function') {
                                displayTechnicalDatabase(window.technicalDatabase);
                            }
                        }, 500);
                    }
                })
                .catch(err => console.error('❌ Error:', err));
        };
    </script>
    <script src="app.js?v=20250126-004"></script>
    <script>
        // Global variables are handled by app.js
        
        // Define functions first - Make globally accessible
        window.setupIntelligentImageAnalysis = function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const removeImage = document.getElementById('removeImage');

            // Upload area click
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload();
                }
            });

            // File input change
            imageInput.addEventListener('change', () => {
                handleImageUpload();
            });

            // Remove image
            removeImage.addEventListener('click', () => {
                imagePreview.style.display = 'none';
                imageInput.value = '';
            });
        };

        // Handle image upload - Make globally accessible
        window.handleImageUpload = function() {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        // Analyze problem function - Make globally accessible
        window.analyzeProblem = async function() {
            try {
                console.log('🔍 Starting problem analysis...');
                
                const imageInput = document.getElementById('imageInput');
                const problemDescription = document.getElementById('problemDescription');
                const vehicleModel = document.getElementById('vehicleModel');
                const analysisResults = document.getElementById('analysisResults');
                
                // Check if elements exist
                if (!imageInput) {
                    console.error('imageInput element not found');
                    return;
                }
                if (!analysisResults) {
                    console.error('analysisResults element not found');
                    return;
                }
                
                // Check if image is uploaded
                if (!imageInput.files[0]) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Kein Bild hochgeladen</h3>
                            </div>
                            <p style="margin: 0; color: #dc2626;">Bitte laden Sie zuerst ein Bild des Problems hoch.</p>
                        </div>
                    `;
                    return;
                }

                // Check file type
                const file = imageInput.files[0];
                if (!file.type.startsWith('image/')) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Ungültiges Dateiformat</h3>
                            </div>
                            <p style="margin: 0; color: #dc2626;">Bitte wählen Sie eine Bilddatei (JPG, PNG, GIF) aus.</p>
                        </div>
                    `;
                    return;
                }

                // Show loading state
                analysisResults.innerHTML = `
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <svg class="w-6 h-6 text-blue-500 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <h3 style="margin: 0; color: #0369a1; font-weight: 600;">Problem wird analysiert...</h3>
                        </div>
                        <p style="margin: 0; color: #0369a1;">Bitte warten Sie, während wir Ihr Problem analysieren.</p>
                    </div>
                `;

                // Convert image to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result.split(',')[1];
                    
                    try {
                        // Call the API
                        const response = await fetch(`${API_BASE}/analyzeUploadedImage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                imageData: base64Image,
                                problemDescription: problemDescription ? problemDescription.value : '',
                                vehicleModel: vehicleModel ? vehicleModel.value : ''
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }

                        const result = await response.json();
                        console.log('API response:', result);

                        // Display results
                        if (result.success && result.solution) {
                            const solution = result.solution;
                            analysisResults.innerHTML = `
                                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 20px; border-radius: 12px; margin-top: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <svg class="w-6 h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 style="margin: 0; color: #166534; font-weight: 600;">Diagnose abgeschlossen</h3>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Diagnose:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.diagnosis || 'Keine spezifische Diagnose verfügbar'}</p>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Schweregrad:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.severity || 'Unbekannt'}</p>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Sofortmaßnahmen:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.immediateAction || 'Keine spezifischen Sofortmaßnahmen verfügbar'}</p>
                                    </div>
                                    <div>
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Schritt-für-Schritt Lösung:</h4>
                                        <div style="color: #166534;">${solution.stepByStepSolution || 'Keine detaillierte Lösung verfügbar'}</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error('Invalid API response');
                        }
                    } catch (error) {
                        console.error('Error analyzing problem:', error);
                        analysisResults.innerHTML = `
                            <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Analyse fehlgeschlagen</h3>
                                </div>
                                <p style="margin: 0; color: #dc2626;">Es gab einen Fehler bei der Analyse. Bitte versuchen Sie es erneut.</p>
                            </div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error in analyzeProblem:', error);
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing troubleshooting page...');
            setupIntelligentImageAnalysis();
            
            // Load technical database immediately and with multiple attempts
            function loadTechDb() {
                if (typeof window.loadTechnicalDatabase === 'function') {
                    console.log('📚 Loading technical database...');
                    window.loadTechnicalDatabase();
                } else {
                    console.error('❌ loadTechnicalDatabase function not found');
                }
            }
            
            // Try immediately
            loadTechDb();
            
            // Try after 500ms
            setTimeout(loadTechDb, 500);
            
            // Try after 1000ms
            setTimeout(loadTechDb, 1000);
            
            // Try after 2000ms
            setTimeout(loadTechDb, 2000);
            
            // Try after 3000ms as final backup
            setTimeout(() => {
                if (!window.technicalDatabase || window.technicalDatabase.length === 0) {
                    console.log('📚 Final backup loading technical database...');
                    loadTechDb();
                }
            }, 3000);
        });

        // Setup intelligent image analysis - Make globally accessible
        window.setupIntelligentImageAnalysis = function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const removeImage = document.getElementById('removeImage');

            // Upload area click
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // File input change
            imageInput.addEventListener('change', handleImageUpload);

            // Remove image
            removeImage.addEventListener('click', (e) => {
                e.stopPropagation();
                imageInput.value = '';
                imagePreview.style.display = 'none';
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#3b82f6';
                uploadArea.style.background = '#eff6ff';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#f9fafb';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#f9fafb';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload();
                }
            });
        }

        // Handle image upload - Make globally accessible
        window.handleImageUpload = function() {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Analyze problem function - Make globally accessible
        window.analyzeProblem = async function() {
            try {
                console.log('🔍 Starting problem analysis...');
                
                const imageInput = document.getElementById('imageInput');
                const problemDescription = document.getElementById('problemDescription');
                const vehicleModel = document.getElementById('vehicleModel');
                const analysisResults = document.getElementById('analysisResults');
                
                // Check if elements exist
                if (!imageInput) {
                    console.error('imageInput element not found');
                    return;
                }
                if (!analysisResults) {
                    console.error('analysisResults element not found');
                    return;
                }
                
                // Check if image is uploaded
                if (!imageInput.files[0]) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Kein Bild hochgeladen</h3>
                            </div>
                            <div style="color: #7f1d1d; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                                Bitte laden Sie zuerst ein Bild des Problems hoch, bevor Sie die Analyse starten.
                            </div>
                            <div style="background: #fef7f7; padding: 12px; border-radius: 6px; border: 1px solid #fecaca;">
                                <div style="font-size: 12px; color: #991b1b; font-weight: 500;">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Unterstützte Formate: JPG, PNG, GIF (max. 10MB)
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Show loading state
                analysisResults.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                            <div class="loading-spinner" style="width: 24px; height: 24px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;"></div>
                            <h3 style="margin: 0; color: #1f2937; font-weight: 600;">Analyse läuft...</h3>
                        </div>
                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                            Bild wird analysiert und mit der technischen Datenbank abgeglichen
                        </div>
                        <div style="color: #9ca3af; font-size: 12px;">
                            Bitte warten Sie einen Moment...
                        </div>
                    </div>
                `;
                
                // Convert image to base64
                const imageFile = imageInput.files[0];
                const imageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
                
                // Call API
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/analyzeUploadedImage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageBase64.split(',')[1],
                        vehicleModel: vehicleModel ? vehicleModel.value : '',
                        problemDescription: problemDescription ? problemDescription.value : ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    analysisResults.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px;">
                            <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 12px; color: #2d2d2d;">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Diagnoseergebnis
                            </h2>
                            <div style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0c4a6e; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Problem identifiziert:</strong> ${data.solution.diagnosis || 'Dashboard-Warnung erkannt'}
                            </div>
                            <div style="background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Schweregrad:</strong> ${data.solution.severity || 'Mittel - Sofortige Aufmerksamkeit erforderlich'}
                            </div>
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Sofortige Aktion:</strong> ${data.solution.immediateAction || 'Fahrzeug sicher abstellen und Motor ausschalten'}
                            </div>
                            <div style="background: #f3f4f6; border: 1px solid #d1d5db; color: #374151; padding: 16px; border-radius: 8px;">
                                <strong>Schritt-für-Schritt-Lösung:</strong><br>
                                ${data.solution.stepByStepSolution || '1. Fahrzeug sicher abstellen<br>2. Motor ausschalten<br>3. Warnleuchte überprüfen<br>4. Bei Bedarf Werkstatt kontaktieren'}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Analyse fehlgeschlagen');
                }
                
            } catch (error) {
                console.error('❌ Error in analyzeProblem:', error);
                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Fehler bei der Analyse</h3>
                            </div>
                            <div style="color: #7f1d1d; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                                Ein Fehler ist aufgetreten: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Use the loadTechnicalDatabase function from app.js
        // This function is already defined in app.js and will be called automatically

        // Display functions are handled by app.js

        // All technical database functions are handled by app.js

        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Search documents function
        window.searchDocuments = function() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            console.log('🔍 Searching documents for:', searchTerm);
            
            if (typeof filterTechnicalDatabase === 'function') {
                filterTechnicalDatabase(searchTerm);
            } else {
                console.error('filterTechnicalDatabase function not found');
            }
        };
        
        // Filter documents function
        window.filterDocuments = function(category) {
            console.log('🔍 Filtering documents by category:', category);
            
            if (typeof filterTechnicalDatabase === 'function') {
                filterTechnicalDatabase('', category);
            } else {
                console.error('filterTechnicalDatabase function not found');
            }
        };
        
        // Wait for app.js to fully load, then initialize
        function waitForAppJs(callback, maxAttempts = 20) {
            let attempts = 0;
            
            const checkInterval = setInterval(() => {
                attempts++;
                console.log(`🔄 Checking for app.js functions... (Attempt ${attempts}/${maxAttempts})`);
                
                if (typeof loadTechnicalDatabase === 'function' && 
                    typeof displayTechnicalDatabase === 'function') {
                    console.log('✅ app.js loaded successfully!');
                    clearInterval(checkInterval);
                    callback();
                } else if (attempts >= maxAttempts) {
                    console.error('❌ Timeout waiting for app.js');
                    clearInterval(checkInterval);
                }
            }, 200);
        }
        
        function waitForTechListElement(callback, maxAttempts = 50) {
            let attempts = 0;
            
            const checkInterval = setInterval(() => {
                attempts++;
                const techListElement = document.getElementById('techList');
                
                console.log(`🔄 Checking for techList element... (Attempt ${attempts}/${maxAttempts})`);
                
                if (techListElement) {
                    console.log('✅ techList element FOUND in DOM!');
                    console.log('   Element:', techListElement.tagName, techListElement.id);
                    console.log('   Parent:', techListElement.parentElement ? techListElement.parentElement.tagName : 'no parent');
                    clearInterval(checkInterval);
                    callback();
                } else if (attempts >= maxAttempts) {
                    console.error('❌ TIMEOUT: techList element never appeared in DOM after', maxAttempts, 'attempts');
                    console.log('   DOM State:', document.readyState);
                    console.log('   Body exists:', !!document.body);
                    console.log('   Body children:', document.body ? document.body.children.length : 0);
                    
                    // List all IDs in the document
                    const allIds = Array.from(document.querySelectorAll('[id]')).map(el => el.id);
                    console.log('   All IDs in DOM:', allIds.join(', '));
                    
                    clearInterval(checkInterval);
                }
            }, 100); // Check every 100ms
        }
        
        function initTroubleshooting() {
            console.log('🚀 Initializing Troubleshooting Page...');
            
            // Setup image analysis
            if (typeof setupIntelligentImageAnalysis === 'function') {
                setupIntelligentImageAnalysis();
            }
            
            // CRITICAL: Wait for techList element to exist in DOM
            console.log('📋 Waiting for techList element to be in DOM...');
            
            waitForTechListElement(() => {
                console.log('📚 Loading Technical Database...');
                console.log('📋 Calling loadTechnicalDatabase() now...');
                loadTechnicalDatabase();
            });
        }
        
        // AGGRESSIVE DOM-ready check - ensure EVERYTHING is loaded
        function ensureDOMReady(callback) {
            console.log('🔄 Checking DOM readiness...', document.readyState);
            
            if (document.readyState === 'complete') {
                console.log('✅ DOM already complete');
                callback();
            } else if (document.readyState === 'interactive') {
                console.log('⏳ DOM interactive, waiting for complete...');
                window.addEventListener('load', () => {
                    console.log('✅ Window load event fired');
                    callback();
                });
            } else {
                console.log('⏳ DOM still loading...');
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('✅ DOMContentLoaded event fired');
                    window.addEventListener('load', () => {
                        console.log('✅ Window load event fired');
                        callback();
                    });
                });
            }
        }
        
        // Start initialization
        console.log('🚀 Starting Troubleshooting Page initialization...');
        console.log('📍 Current DOM state:', document.readyState);
        
        ensureDOMReady(() => {
            console.log('✅ DOM is FULLY ready, starting init...');
            waitForAppJs(() => {
                // Call both methods for maximum reliability
                initTroubleshooting();
                
                // Also try simple direct load
                if (typeof window.loadTechDB === 'function') {
                    console.log('🔧 Also calling simple loadTechDB...');
                    setTimeout(() => window.loadTechDB(), 100);
                }
            });
        });
        
        // EMERGENCY FALLBACK: Load after 2 seconds no matter what
        setTimeout(() => {
            console.log('⏰ Emergency fallback triggered after 2s...');
            if (document.getElementById('techList') && window.technicalDatabase.length > 0) {
                console.log('✅ Emergency: Calling displayTechnicalDatabase with cached data...');
                if (typeof displayTechnicalDatabase === 'function') {
                    displayTechnicalDatabase(window.technicalDatabase);
                }
            } else if (typeof window.loadTechDB === 'function') {
                console.log('🔄 Emergency: Calling loadTechDB...');
                window.loadTechDB();
            }
        }, 2000);
        
        // ABSOLUTE LAST RESORT: Manually trigger after 3 seconds
        setTimeout(() => {
            console.log('🚨 LAST RESORT: Trying direct manual call...');
            const techListEl = document.getElementById('techList');
            if (techListEl && typeof loadTechnicalDatabase === 'function') {
                console.log('✅ Last resort: Calling loadTechnicalDatabase()...');
                loadTechnicalDatabase();
            } else {
                console.log('❌ Last resort failed - techList:', !!techListEl, 'loadTechnicalDatabase:', typeof loadTechnicalDatabase);
            }
        }, 3000);
    </script>
</body>
</html>