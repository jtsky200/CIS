<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadillac EV Assistant - Troubleshooting</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/i18n.js?v=1730000020"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <!-- Advanced Troubleshooting Integration -->
        <!-- <script src="../integrate-advanced-troubleshooting.js"></script> -->
        <!-- File not accessible from public folder - functionality integrated in app.js -->
        <!-- Completely Automatic Advanced API -->
        <script src="auto-start-advanced-api.js"></script>
        <!-- Automatic Startup Manager -->
        <script src="startup-api.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-brand-icon" id="navLogo">C</div>
            <span id="navBrandText">Cadillac EV</span>
        </div>
        <div class="nav-menu">
            <a class="nav-item" href="dashboard.html" data-page="dashboard" data-i18n="nav.dashboard">Dashboard</a>
            <a class="nav-item" href="chat.html" data-page="chat" data-i18n="nav.chat">Chat</a>
            <a class="nav-item active" href="troubleshooting.html" data-page="troubleshooting" data-i18n="nav.troubleshooting">Troubleshooting</a>
            <a class="nav-item" href="settings.html" data-page="settings" data-i18n="nav.settings">Einstellungen</a>
            <select class="language-selector" id="languageSelector" onchange="if(window.i18n) window.i18n.changeLanguage(this.value)" title="Sprache w√§hlen">
                <option value="de">DE</option>
                <option value="en">EN</option>
                <option value="fr">FR</option>
            </select>
            <button class="theme-toggle" id="themeToggle" title="Theme wechseln">
                <svg class="theme-icon sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <svg class="theme-icon moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Troubleshooting Page -->
    <div class="page active" id="troubleshootingPage">
        <div class="troubleshooting-container">
            <h1 style="font-size: 32px; font-weight: 200; margin: 0 0 8px; color: #2a2a2a;" data-i18n="troubleshooting.title">Troubleshooting</h1>
            <p style="color: #6b7280; font-size: 16px; margin: 0 0 32px;" data-i18n="troubleshooting.subtitle">Hilfe bei Problemen mit Ihrem Cadillac EV</p>
            
            <!-- Troubleshooting Tools -->
            <div style="margin-bottom: 3rem;">
                <!-- Upload Image Section -->
                <div class="settings-section">
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: #2d2d2d;" data-i18n="troubleshooting.intelligentDiagnosis">Intelligente Problemdiagnose</h2>
                    <p style="color: #6b7280; font-size: 15px; margin-bottom: 24px; line-height: 1.6;" data-i18n="troubleshooting.diagnosisDescription">Laden Sie ein Bild des Problems hoch und erhalten Sie eine sofortige AI-gest√ºtzte Diagnose mit L√∂sungsvorschl√§gen aus unseren Fahrzeughandb√ºchern.</p>
                    
                    <div class="upload-area" id="uploadArea" style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f9fafb;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'">
                        <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 64px; height: 64px; margin: 0 auto 16px; color: #9ca3af;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <div class="upload-text" style="font-size: 17px; font-weight: 600; color: #374151; margin-bottom: 8px;" data-i18n="troubleshooting.uploadImage">Bild hochladen</div>
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 12px;" data-i18n="troubleshooting.clickOrDrag">Klicken zum Ausw√§hlen oder Drag & Drop</div>
                        <div class="upload-subtext" style="font-size: 13px; color: #9ca3af;" data-i18n="troubleshooting.fileFormats">JPG, PNG, GIF - Max. 10MB</div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="image-preview" id="imagePreview" style="display: none; margin-top: 24px; padding: 16px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px;">
                        <div style="position: relative; display: inline-block;">
                            <img id="previewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; display: block;">
                            <button id="removeImage" style="position: absolute; top: 8px; right: 8px; padding: 8px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: all 0.2s;" onmouseover="this.style.background='rgba(220, 38, 38, 1)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.9)'">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="issue-description" style="margin-top: 24px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: #374151;" data-i18n="troubleshooting.describeProblem">Problem beschreiben (optional)</label>
                        <textarea id="problemDescription" data-i18n-placeholder="troubleshooting.problemPlaceholder" placeholder="Beschreiben Sie das Problem genau oder lassen Sie das Feld leer f√ºr reine Bildanalyse..." style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; font-family: inherit; font-size: 15px; font-weight: 500; color: #1f2937; background: #ffffff; resize: vertical; min-height: 120px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"></textarea>
                    </div>
                    
                    <div class="vehicle-model" style="margin-top: 20px; text-align: right;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: #374151;" data-i18n="troubleshooting.vehicleModel">Fahrzeugmodell</label>
                        <select id="vehicleModel" style="width: auto; max-width: 300px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; font-size: 15px; font-weight: 500; background: #ffffff; color: #1f2937; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                            <option value="" data-i18n="troubleshooting.selectModel">Modell ausw√§hlen...</option>
                            <option value="Cadillac LYRIQ">Cadillac LYRIQ</option>
                            <option value="Cadillac VISTIQ">Cadillac VISTIQ</option>
                            <option value="Cadillac OPTIQ">Cadillac OPTIQ</option>
                        </select>
                    </div>
                    
                    <div style="text-align: right;">
                        <button id="analyzeProblem" class="btn-primary" style="margin-top: 24px; width: auto; display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 15px; font-weight: 600;" onclick="analyzeProblem()">
                            <span id="analyzeText" data-i18n="troubleshooting.analyzeProblem">Problem analysieren</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Results Section -->
            <div id="analysisResults" style="margin-top: 2rem;">
                <!-- Results will be displayed here -->
            </div>

            <!-- Technical Database Section -->
            <div class="settings-section" style="margin-top: 3rem;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: #2d2d2d;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Technische Datenbank
                </h2>
                <p style="color: #6b7280; font-size: 15px; margin-bottom: 24px; line-height: 1.6;">Durchsuchen Sie unsere umfassende technische Dokumentation mit Handb√ºchern, Anleitungen und Troubleshooting-Guides f√ºr alle Cadillac EV-Modelle.</p>
                
                <!-- Search Bar -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="Technische Dokumentation durchsuchen..." style="flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; font-size: 15px; font-weight: 500; color: #1f2937; background: #ffffff; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <button id="searchBtn" class="btn-primary" style="padding: 12px 20px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;" onclick="searchDocuments()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Suchen
                    </button>
                </div>

                <!-- Category Filters -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
                    <button class="category-btn active" data-category="all" onclick="filterDocuments('all')" style="padding: 8px 16px; border: 1px solid #3b82f6; background: #3b82f6; color: white; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Alle (50)</button>
                    <button class="category-btn" data-category="charging" onclick="filterDocuments('charging')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Charging (1)</button>
                    <button class="category-btn" data-category="general" onclick="filterDocuments('general')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">General (16)</button>
                    <button class="category-btn" data-category="lyriq" onclick="filterDocuments('lyriq')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Lyriq owner manuals (4)</button>
                    <button class="category-btn" data-category="manual" onclick="filterDocuments('manual')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Manual (2)</button>
                    <button class="category-btn" data-category="optiq" onclick="filterDocuments('optiq')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Optiq owner manuals (12)</button>
                    <button class="category-btn" data-category="service" onclick="filterDocuments('service')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Service Manual (2)</button>
                    <button class="category-btn" data-category="specifications" onclick="filterDocuments('specifications')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Specifications (1)</button>
                    <button class="category-btn" data-category="troubleshooting" onclick="filterDocuments('troubleshooting')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Troubleshooting (2)</button>
                    <button class="category-btn" data-category="vistiq" onclick="filterDocuments('vistiq')" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Vistiq owner manuals (10)</button>
                </div>

                <!-- Documents List -->
                <div id="techList" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                    <!-- Documents will be loaded here -->
                </div>

                <!-- Pagination -->
                <div id="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 20px;">
                    <div style="color: #6b7280; font-size: 14px;">
                        <span id="paginationInfo">Zeige 1-20 von 50 Dokumenten</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="prevBtn" onclick="changePage(-1)" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;" disabled>Zur√ºck</button>
                        <span id="pageInfo" style="padding: 8px 16px; color: #6b7280; font-size: 14px;">Seite 1 von 3</span>
                        <button id="nextBtn" onclick="changePage(1)" style="padding: 8px 16px; border: 1px solid #e5e7eb; background: #ffffff; color: #374151; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Weiter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Global variables are handled by app.js
        
        // Define functions first - Make globally accessible
        window.setupIntelligentImageAnalysis = function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const removeImage = document.getElementById('removeImage');

            // Upload area click
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload();
                }
            });

            // File input change
            imageInput.addEventListener('change', () => {
                handleImageUpload();
            });

            // Remove image
            removeImage.addEventListener('click', () => {
                imagePreview.style.display = 'none';
                imageInput.value = '';
            });
        };

        // Handle image upload - Make globally accessible
        window.handleImageUpload = function() {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        // Analyze problem function - Make globally accessible
        window.analyzeProblem = async function() {
            try {
                console.log('üîç Starting problem analysis...');
                
                const imageInput = document.getElementById('imageInput');
                const problemDescription = document.getElementById('problemDescription');
                const vehicleModel = document.getElementById('vehicleModel');
                const analysisResults = document.getElementById('analysisResults');
                
                // Check if elements exist
                if (!imageInput) {
                    console.error('imageInput element not found');
                    return;
                }
                if (!analysisResults) {
                    console.error('analysisResults element not found');
                    return;
                }
                
                // Check if image is uploaded
                if (!imageInput.files[0]) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Kein Bild hochgeladen</h3>
                            </div>
                            <p style="margin: 0; color: #dc2626;">Bitte laden Sie zuerst ein Bild des Problems hoch.</p>
                        </div>
                    `;
                    return;
                }

                // Check file type
                const file = imageInput.files[0];
                if (!file.type.startsWith('image/')) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Ung√ºltiges Dateiformat</h3>
                            </div>
                            <p style="margin: 0; color: #dc2626;">Bitte w√§hlen Sie eine Bilddatei (JPG, PNG, GIF) aus.</p>
                        </div>
                    `;
                    return;
                }

                // Show loading state
                analysisResults.innerHTML = `
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <svg class="w-6 h-6 text-blue-500 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <h3 style="margin: 0; color: #0369a1; font-weight: 600;">Problem wird analysiert...</h3>
                        </div>
                        <p style="margin: 0; color: #0369a1;">Bitte warten Sie, w√§hrend wir Ihr Problem analysieren.</p>
                    </div>
                `;

                // Convert image to base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result.split(',')[1];
                    
                    try {
                        // Call the API
                        const response = await fetch(`${API_BASE}/analyzeUploadedImage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                imageData: base64Image,
                                problemDescription: problemDescription ? problemDescription.value : '',
                                vehicleModel: vehicleModel ? vehicleModel.value : ''
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }

                        const result = await response.json();
                        console.log('API response:', result);

                        // Display results
                        if (result.success && result.solution) {
                            const solution = result.solution;
                            analysisResults.innerHTML = `
                                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 20px; border-radius: 12px; margin-top: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <svg class="w-6 h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 style="margin: 0; color: #166534; font-weight: 600;">Diagnose abgeschlossen</h3>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Diagnose:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.diagnosis || 'Keine spezifische Diagnose verf√ºgbar'}</p>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Schweregrad:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.severity || 'Unbekannt'}</p>
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Sofortma√ünahmen:</h4>
                                        <p style="margin: 0; color: #166534;">${solution.immediateAction || 'Keine spezifischen Sofortma√ünahmen verf√ºgbar'}</p>
                                    </div>
                                    <div>
                                        <h4 style="color: #166534; font-weight: 600; margin-bottom: 10px;">Schritt-f√ºr-Schritt L√∂sung:</h4>
                                        <div style="color: #166534;">${solution.stepByStepSolution || 'Keine detaillierte L√∂sung verf√ºgbar'}</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            throw new Error('Invalid API response');
                        }
                    } catch (error) {
                        console.error('Error analyzing problem:', error);
                        analysisResults.innerHTML = `
                            <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Analyse fehlgeschlagen</h3>
                                </div>
                                <p style="margin: 0; color: #dc2626;">Es gab einen Fehler bei der Analyse. Bitte versuchen Sie es erneut.</p>
                            </div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Error in analyzeProblem:', error);
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing troubleshooting page...');
            setupIntelligentImageAnalysis();
            
            // Load technical database immediately and with multiple attempts
            function loadTechDb() {
                if (typeof window.loadTechnicalDatabase === 'function') {
                    console.log('üìö Loading technical database...');
                    window.loadTechnicalDatabase();
                } else {
                    console.error('‚ùå loadTechnicalDatabase function not found');
                }
            }
            
            // Try immediately
            loadTechDb();
            
            // Try after 500ms
            setTimeout(loadTechDb, 500);
            
            // Try after 1000ms
            setTimeout(loadTechDb, 1000);
            
            // Try after 2000ms
            setTimeout(loadTechDb, 2000);
            
            // Try after 3000ms as final backup
            setTimeout(() => {
                if (!window.technicalDatabase || window.technicalDatabase.length === 0) {
                    console.log('üìö Final backup loading technical database...');
                    loadTechDb();
                }
            }, 3000);
        });

        // Setup intelligent image analysis - Make globally accessible
        window.setupIntelligentImageAnalysis = function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const removeImage = document.getElementById('removeImage');

            // Upload area click
            uploadArea.addEventListener('click', () => {
                imageInput.click();
            });

            // File input change
            imageInput.addEventListener('change', handleImageUpload);

            // Remove image
            removeImage.addEventListener('click', (e) => {
                e.stopPropagation();
                imageInput.value = '';
                imagePreview.style.display = 'none';
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#3b82f6';
                uploadArea.style.background = '#eff6ff';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#f9fafb';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.background = '#f9fafb';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    imageInput.files = files;
                    handleImageUpload();
                }
            });
        }

        // Handle image upload - Make globally accessible
        window.handleImageUpload = function() {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Analyze problem function - Make globally accessible
        window.analyzeProblem = async function() {
            try {
                console.log('üîç Starting problem analysis...');
                
                const imageInput = document.getElementById('imageInput');
                const problemDescription = document.getElementById('problemDescription');
                const vehicleModel = document.getElementById('vehicleModel');
                const analysisResults = document.getElementById('analysisResults');
                
                // Check if elements exist
                if (!imageInput) {
                    console.error('imageInput element not found');
                    return;
                }
                if (!analysisResults) {
                    console.error('analysisResults element not found');
                    return;
                }
                
                // Check if image is uploaded
                if (!imageInput.files[0]) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Kein Bild hochgeladen</h3>
                            </div>
                            <div style="color: #7f1d1d; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                                Bitte laden Sie zuerst ein Bild des Problems hoch, bevor Sie die Analyse starten.
                            </div>
                            <div style="background: #fef7f7; padding: 12px; border-radius: 6px; border: 1px solid #fecaca;">
                                <div style="font-size: 12px; color: #991b1b; font-weight: 500;">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Unterst√ºtzte Formate: JPG, PNG, GIF (max. 10MB)
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Show loading state
                analysisResults.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                            <div class="loading-spinner" style="width: 24px; height: 24px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;"></div>
                            <h3 style="margin: 0; color: #1f2937; font-weight: 600;">Analyse l√§uft...</h3>
                        </div>
                        <div style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                            Bild wird analysiert und mit der technischen Datenbank abgeglichen
                        </div>
                        <div style="color: #9ca3af; font-size: 12px;">
                            Bitte warten Sie einen Moment...
                        </div>
                    </div>
                `;
                
                // Convert image to base64
                const imageFile = imageInput.files[0];
                const imageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
                
                // Call API
                const response = await fetch('https://us-central1-cis-de.cloudfunctions.net/analyzeUploadedImage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageBase64.split(',')[1],
                        vehicleModel: vehicleModel ? vehicleModel.value : '',
                        problemDescription: problemDescription ? problemDescription.value : ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    analysisResults.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px;">
                            <h2 style="font-size: 22px; font-weight: 600; margin-bottom: 12px; color: #2d2d2d;">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Diagnoseergebnis
                            </h2>
                            <div style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0c4a6e; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Problem identifiziert:</strong> ${data.solution.diagnosis || 'Dashboard-Warnung erkannt'}
                            </div>
                            <div style="background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Schweregrad:</strong> ${data.solution.severity || 'Mittel - Sofortige Aufmerksamkeit erforderlich'}
                            </div>
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <strong>Sofortige Aktion:</strong> ${data.solution.immediateAction || 'Fahrzeug sicher abstellen und Motor ausschalten'}
                            </div>
                            <div style="background: #f3f4f6; border: 1px solid #d1d5db; color: #374151; padding: 16px; border-radius: 8px;">
                                <strong>Schritt-f√ºr-Schritt-L√∂sung:</strong><br>
                                ${data.solution.stepByStepSolution || '1. Fahrzeug sicher abstellen<br>2. Motor ausschalten<br>3. Warnleuchte √ºberpr√ºfen<br>4. Bei Bedarf Werkstatt kontaktieren'}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Analyse fehlgeschlagen');
                }
                
            } catch (error) {
                console.error('‚ùå Error in analyzeProblem:', error);
                const analysisResults = document.getElementById('analysisResults');
                if (analysisResults) {
                    analysisResults.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h3 style="margin: 0; color: #dc2626; font-weight: 600;">Fehler bei der Analyse</h3>
                            </div>
                            <div style="color: #7f1d1d; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                                Ein Fehler ist aufgetreten: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Use the loadTechnicalDatabase function from app.js
        // This function is already defined in app.js and will be called automatically

        // Display functions are handled by app.js

        // All technical database functions are handled by app.js

        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Search documents function
        window.searchDocuments = function() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            console.log('üîç Searching documents for:', searchTerm);
            
            if (typeof filterTechnicalDatabase === 'function') {
                filterTechnicalDatabase(searchTerm);
            } else {
                console.error('filterTechnicalDatabase function not found');
            }
        };
        
        // Filter documents function
        window.filterDocuments = function(category) {
            console.log('üîç Filtering documents by category:', category);
            
            if (typeof filterTechnicalDatabase === 'function') {
                filterTechnicalDatabase('', category);
            } else {
                console.error('filterTechnicalDatabase function not found');
            }
        };
    </script>
</body>
</html>